<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Phishing Awareness Quiz</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: #333;
      overflow-x: hidden;
      position: relative;
      font-weight: 500;
      letter-spacing: 0.3px;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(circle at 1px 1px, rgba(46, 125, 50, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
      pointer-events: none;
      z-index: -1;
    }

    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%);
      pointer-events: none;
      z-index: -2;
    }

    /* Floating Security Shapes Container */
    .bg-shapes {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
      overflow: hidden;
    }

    .floating-shape {
      position: absolute;
      opacity: 0.15;
      filter: drop-shadow(0 2px 4px rgba(46, 125, 50, 0.1));
    }

    .shape-1 {
      width: 120px;
      height: 120px;
      top: 10%;
      left: 5%;
      animation: float-shape-1 20s ease-in-out infinite;
    }

    .shape-2 {
      width: 100px;
      height: 100px;
      top: 20%;
      right: 10%;
      animation: float-shape-2 25s ease-in-out infinite;
    }

    .shape-3 {
      width: 80px;
      height: 80px;
      top: 50%;
      left: 15%;
      animation: float-shape-3 18s ease-in-out infinite;
    }

    .shape-4 {
      width: 110px;
      height: 110px;
      bottom: 15%;
      right: 8%;
      animation: float-shape-4 22s ease-in-out infinite;
    }

    .shape-5 {
      width: 90px;
      height: 90px;
      top: 60%;
      right: 25%;
      animation: float-shape-5 24s ease-in-out infinite;
    }

    .shape-6 {
      width: 70px;
      height: 70px;
      bottom: 30%;
      left: 50%;
      animation: float-shape-6 19s ease-in-out infinite;
    }

    .shape-7 {
      width: 95px;
      height: 95px;
      top: 30%;
      left: 60%;
      animation: float-shape-7 23s ease-in-out infinite;
    }

    .shape-8 {
      width: 85px;
      height: 85px;
      bottom: 10%;
      left: 30%;
      animation: float-shape-8 21s ease-in-out infinite;
    }

    @keyframes float-shape-1 {
      0%, 100% { transform: translateX(0px) translateY(0px) rotate(0deg); }
      25% { transform: translateX(30px) translateY(-30px) rotate(90deg); }
      50% { transform: translateX(0px) translateY(-60px) rotate(180deg); }
      75% { transform: translateX(-30px) translateY(-30px) rotate(270deg); }
    }

    @keyframes float-shape-2 {
      0%, 100% { transform: translateX(0px) translateY(0px) scale(1); }
      25% { transform: translateX(-40px) translateY(-40px) scale(1.1); }
      50% { transform: translateX(0px) translateY(-80px) scale(1); }
      75% { transform: translateX(40px) translateY(-40px) scale(1.1); }
    }

    @keyframes float-shape-3 {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      33% { transform: translateY(-50px) rotate(120deg); }
      66% { transform: translateY(-100px) rotate(240deg); }
    }

    @keyframes float-shape-4 {
      0%, 100% { transform: translateX(0px) translateY(0px); }
      50% { transform: translateX(-60px) translateY(-60px); }
    }

    @keyframes float-shape-5 {
      0%, 100% { transform: translateY(0px) scale(1); }
      50% { transform: translateY(-80px) scale(1.15); }
    }

    @keyframes float-shape-6 {
      0%, 100% { transform: translateX(0px) translateY(0px) rotate(0deg); }
      50% { transform: translateX(70px) translateY(-70px) rotate(180deg); }
    }

    @keyframes float-shape-7 {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      33% { transform: translateY(-40px) rotate(120deg); }
      66% { transform: translateY(-80px) rotate(240deg); }
    }

    @keyframes float-shape-8 {
      0%, 100% { transform: translateX(0px) translateY(0px) scale(1); }
      25% { transform: translateX(50px) translateY(-50px) scale(0.9); }
      50% { transform: translateX(0px) translateY(-100px) scale(1); }
      75% { transform: translateX(-50px) translateY(-50px) scale(0.9); }
    }

    @media (max-width: 768px) {
      .floating-shape {
        opacity: 0.08;
      }

      .shape-1 { width: 80px; height: 80px; }
      .shape-2 { width: 70px; height: 70px; }
      .shape-3 { width: 60px; height: 60px; }
      .shape-4 { width: 75px; height: 75px; }
      .shape-5 { width: 65px; height: 65px; }
      .shape-6 { width: 55px; height: 55px; }
      .shape-7 { width: 70px; height: 70px; }
      .shape-8 { width: 60px; height: 60px; }
    }

    .home-icon {
      position: fixed;
      top: 1.8rem;
      left: 2rem;
      width: 3.2rem;
      height: 3.2rem;
      background: linear-gradient(135deg, #2e7d32, #4caf50);
      color: #fff;
      border: 2px solid #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      line-height: 1;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 1001;
      text-decoration: none;
      box-shadow: 0 4px 15px rgba(46, 125, 50, 0.3);
    }

    .home-icon i {
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      margin-top: 0.15rem;
    }

    .home-icon:hover {
      background: #fff;
      color: #2e7d32;
      transform: scale(1.12) translateY(-2px);
      box-shadow: 0 6px 20px rgba(46, 125, 50, 0.4);
      border-color: #2e7d32;
    }

    .home-icon.disabled {
      background: #ccc;
      color: #888;
      border-color: #ccc;
      cursor: not-allowed;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .home-icon.disabled:hover {
      background: #ccc;
      color: #888;
      transform: none;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    canvas#matrix {
      display: none;
    }

    /* Employee Form Styles */
    .quiz-container {
      max-width: 440px;
      margin: 0.4rem auto 1.5rem auto;
      background: rgba(255, 255, 255, 0.96);
      backdrop-filter: blur(10px);
      padding: 1.2rem;
      border-radius: 12px;
      border: 2px solid #2e7d32;
      box-shadow: 0 8px 32px rgba(46, 125, 50, 0.2);
      animation: slideUp 0.7s ease;
      z-index: 1;
      position: relative;
      overflow: hidden;
    }

    .quiz-container::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(76, 175, 80, 0.05) 0%, transparent 70%);
      pointer-events: none;
    }

    .quiz-container::after {
      content: '';
      position: absolute;
      bottom: -50%;
      left: -50%;
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(46, 125, 50, 0.05) 0%, transparent 70%);
      pointer-events: none;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(40px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .quiz-container h1 {
      animation: fadeInDown 0.8s ease 0.1s both;
      position: relative;
      z-index: 2;
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .quiz-container form > div {
      animation: fadeInUp 0.6s ease both;
      position: relative;
      z-index: 2;
    }

    .quiz-container form > div:nth-child(1) {
      animation-delay: 0.2s;
    }

    .quiz-container form > div:nth-child(2) {
      animation-delay: 0.3s;
    }

    .quiz-container #verificationMessage {
      animation-delay: 0.4s;
    }

    .quiz-container button[type="submit"] {
      animation: fadeInUp 0.6s ease 0.5s both;
    }

    .quiz-container button[type="button"] {
      animation: fadeInUp 0.6s ease 0.6s both;
    }

    .back-home-btn-quiz {
      width: 100%;
      padding: 0.6rem 1.5rem;
      background: rgba(255, 255, 255, 0.6);
      color: #2e7d32;
      border: 1px solid rgba(46, 125, 50, 0.3);
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin-top: 0.5rem;
      display: block;
      text-align: center;
      text-decoration: none;
      backdrop-filter: blur(10px);
      letter-spacing: 0.2px;
    }

    .back-home-btn-quiz:hover {
      background: rgba(46, 125, 50, 0.1);
      border-color: #2e7d32;
      transform: translateY(-2px);
    }

    /* Guidelines Card System */
    .guidelines-card {
      border-left: 5px solid #2e7d32;
      background: #ffffff;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
    }

    .guidelines-card:hover {
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
      transform: translateY(-2px);
    }

    /* Copyright Footer */
    .copyright-footer {
      text-align: center;
      font-size: 0.75rem;
      color: #2e7d32;
      font-weight: 600;
      margin-top: 0.8rem;
      padding-top: 0.8rem;
      border-top: 1px solid #2e7d32;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* FDC Logo in Navbar */
    .fdc-logo-nav {
      position: fixed;
      top: 15px;
      right: 15px;
      left: auto;
      transform: none;
      width: 120px;
      height: 60px;
      z-index: 1001;
      opacity: 1;
      pointer-events: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.3s ease;
      background: transparent;
      padding: 10px;
    }

    .fdc-logo-nav:hover {
      transform: scale(1.08);
    }

    .fdc-logo-nav.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    .fdc-logo-nav.hidden {
      opacity: 0;
      pointer-events: none;
      visibility: hidden;
    }

    .fdc-logo-nav.quiz-active {
      top: auto;
      bottom: 15px;
      right: 15px;
      left: auto;
      transform: none;
    }

    .fdc-logo-svg {
      width: 100%;
      height: auto;
      max-width: 140px;
      filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.15));
    }

    body {
      padding-top: 40px;
    }

    /* Employee Form Input Styling */
    .quiz-container input[type="email"],
    .quiz-container input[type="text"] {
      width: 100% !important;
      padding: 0.7rem !important;
      border: 2px solid #2e7d32 !important;
      border-radius: 8px !important;
      font-size: 0.95rem !important;
      font-weight: 500 !important;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
      transition: all 0.3s ease !important;
      background: rgba(255, 255, 255, 0.8) !important;
      color: #333 !important;
      margin-bottom: 0.6rem !important;
    }

    .quiz-container input[type="email"]:focus,
    .quiz-container input[type="text"]:focus {
      outline: none !important;
      border-color: #4caf50 !important;
      background: #ffffff !important;
      box-shadow: 0 0 15px rgba(76, 175, 80, 0.3) !important;
      transform: translateY(-2px) !important;
    }

    .quiz-container input[type="email"]:hover,
    .quiz-container input[type="text"]:hover {
      border-color: #4caf50 !important;
      background: #f9fff9 !important;
    }

    /* Button Styling */
    .quiz-container button[type="submit"],
    .quiz-container button[type="button"] {
      width: 100% !important;
      padding: 0.7rem !important;
      border-radius: 8px !important;
      font-weight: 700 !important;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
      font-size: 0.95rem !important;
      cursor: pointer !important;
      transition: all 0.3s ease !important;
      border: none !important;
    }

    .quiz-container button[type=\"submit\"] {
      background: linear-gradient(135deg, #2e7d32, #4caf50) !important;
      color: #fff !important;
      margin-bottom: 0.4rem !important;
      box-shadow: 0 4px 15px rgba(46, 125, 50, 0.3) !important;
    }

    .quiz-container button[type=\"submit\"]:hover {
      transform: translateY(-3px) !important;
      box-shadow: 0 6px 20px rgba(46, 125, 50, 0.4) !important;
    }

    .quiz-container button[type=\"submit\"]:active {
      transform: translateY(-1px) !important;
    }

    .quiz-container button[type=\"button\"] {
      background: rgba(46, 125, 50, 0.1) !important;
      color: #2e7d32 !important;
      border: 2px solid #2e7d32 !important;
    }

    .quiz-container button[type=\"button\"]:hover {
      background: #2e7d32 !important;
      color: #fff !important;
      transform: translateY(-2px) !important;
    }

    h1 {
      text-align: center;
      color: #2e7d32;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin-bottom: 2rem;
      text-shadow: none;
      font-weight: 800;
      font-size: 2rem;
      letter-spacing: -0.5px;
    }

    /* Split Screen Layout */
    .split-screen-wrapper {
      display: flex;
      gap: 1rem;
      padding: 1.5rem;
      background: #f5f5f5;
      min-height: 100vh;
      margin-top: 0.25rem;
    }

    .main-stage {
      flex: 0 0 70%;
      background: #ffffff;
      padding: 2rem;
      border-radius: 8px;
      border: 2px solid #2e7d32;
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.1);
      display: flex;
      flex-direction: column;
    }

    .question-navigator {
      flex: 0 0 30%;
      background: #ffffff;
      padding: 1rem;
      border-radius: 8px;
      border: 2px solid #2e7d32;
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Main Stage Content */
    .timer-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #2e7d32;
    }

    .progress-info {
      font-size: 0.95rem;
      color: #222;
      font-weight: 700;
    }

    .timer {
      font-size: 1.3rem;
      font-weight: 700;
      color: #2e7d32;
      padding: 0.5rem 1rem;
      border: 2px solid #2e7d32;
      border-radius: 6px;
      min-width: 70px;
      text-align: center;
    }

    .timer.warning {
      color: #ff9800;
      border-color: #ff9800;
    }

    .timer.danger {
      color: #c62828;
      border-color: #c62828;
    }

    .question-content {
      flex: 1;
      overflow: hidden;
      margin-bottom: 1.5rem;
      display: flex;
      flex-direction: column;
    }

    .question-text {
      font-size: 1.1rem;
      color: #222;
      font-weight: 700;
      margin-bottom: 1rem;
      line-height: 1.6;
      flex-shrink: 0;
    }

    .question-image {
      width: 100%;
      max-height: 150px;
      object-fit: contain;
      border-radius: 6px;
      border: 2px solid #2e7d32;
      margin-bottom: 1rem;
      flex-shrink: 0;
    }

    .options {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      overflow-y: auto;
      flex: 1;
      padding-right: 0.5rem;
    }

    .options label {
      display: flex;
      align-items: flex-start;
      background: #f9f9f9;
      border: 2px solid #e0e0e0;
      padding: 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #222;
      font-size: 0.9rem;
      line-height: 1.4;
      flex-shrink: 0;
    }

    .options label:hover {
      background: #f0f7f0;
      border-color: #2e7d32;
      transform: translateX(4px);
    }

    .options input[type="radio"] {
      margin-right: 0.75rem;
      margin-top: 0.2rem;
      cursor: pointer;
      width: 18px;
      height: 18px;
    }

    .options label.selected {
      background: #e8f5e9;
      border-color: #2e7d32;
      font-weight: 700;
    }

    .control-buttons {
      display: flex;
      gap: 0.8rem;
      justify-content: center;
      flex-wrap: wrap;
      padding-top: 1rem;
      border-top: 2px solid #e0e0e0;
    }

    .btn-nav, .btn-action {
      padding: 0.7rem 1.2rem;
      font-size: 0.95rem;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 700;
      white-space: nowrap;
    }

    .btn-nav {
      background: #2e7d32;
      color: #fff;
    }

    .btn-nav:hover:not(:disabled) {
      background: #1b4620;
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(46, 125, 50, 0.2);
    }

    .btn-nav:disabled {
      background: #ccc;
      color: #888;
      cursor: not-allowed;
    }

    .btn-clear {
      background: transparent;
      color: #2e7d32;
      border: 2px solid #2e7d32;
    }

    .btn-clear:hover {
      background: #2e7d32;
      color: #fff;
      transform: translateY(-2px);
    }

    .btn-submit {
      background: #4caf50;
      color: #fff;
      border: none;
      padding: 0.7rem 1.5rem;
      font-size: 0.9rem;
      font-weight: 700;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      flex-shrink: 0;
      white-space: nowrap;
    }

    .btn-submit:hover {
      background: #388e3c;
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
    }

    .btn-exit {
      background: transparent;
      color: #2e7d32;
      border: 2px solid #2e7d32;
      width: 100%;
      padding: 0.6rem;
      margin-top: 0.4rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 700;
      transition: all 0.3s ease;
      flex-shrink: 0;
      font-size: 0.85rem;
    }

    .btn-exit:hover {
      background: #2e7d32;
      color: #fff;
    }

    .btn-submit-navigator {
      background: #4caf50;
      color: #fff;
      width: 100%;
      padding: 0.7rem;
      margin-bottom: 0.6rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 700;
      transition: all 0.3s ease;
      flex-shrink: 0;
      font-size: 0.9rem;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn-submit-navigator:hover:not(:disabled) {
      background: #388e3c;
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
    }

    .btn-submit-navigator:disabled {
      background: #ccc;
      color: #888;
      cursor: not-allowed;
      opacity: 0.6;
    }

    /* Question Navigator Styles */
    .navigator-header {
      font-weight: 700;
      font-size: 0.9rem;
      color: #2e7d32;
      margin-bottom: 0.8rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #2e7d32;
    }

    .navigator-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.6rem;
      flex: 0;
    }

    .question-btn {
      aspect-ratio: 1;
      border: 2px solid #e0e0e0;
      background: #ffffff;
      color: #222;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.75rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 35px;
    }

    .question-btn:hover {
      border-color: #2e7d32;
      background: #f9f9f9;
    }

    /* Question States */
    .question-btn.unattempted {
      background: #ffffff;
      border: 2px solid #ccc;
      color: #999;
    }

    .question-btn.answered {
      background: #e3f2fd;
      border: 2px solid #2196f3;
      color: #2196f3;
    }

    .question-btn.current {
      background: #2e7d32;
      color: #fff;
      border: 2px solid #2e7d32;
      box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.2);
      font-size: 0.9rem;
    }

    .question-btn.correct {
      background: #4caf50;
      color: #fff;
      border: 2px solid #4caf50;
    }

    .question-btn.incorrect {
      background: #f44336;
      color: #fff;
      border: 2px solid #f44336;
    }

    /* Performance Summary */
    .performance-summary {
      text-align: center;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .summary-header {
      font-size: 1.8rem;
      color: #2e7d32;
      font-weight: 700;
      margin-bottom: 1.5rem;
    }

    .summary-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-box {
      background: #f9f9f9;
      padding: 1.5rem;
      border-radius: 6px;
      border: 2px solid #e0e0e0;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }

    .stat-value {
      font-size: 1.8rem;
      color: #2e7d32;
      font-weight: 700;
    }

    .status-badge {
      font-size: 1.3rem;
      font-weight: 700;
      padding: 1rem 2rem;
      border-radius: 6px;
      margin: 1.5rem 0;
      display: inline-block;
    }

    .status-passed {
      background: #e8f5e9;
      color: #2e7d32;
      border: 2px solid #4caf50;
    }

    .status-failed {
      background: #ffebee;
      color: #c62828;
      border: 2px solid #f44336;
    }

    .employee-info {
      background: #f5f5f5;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
    }

    .retake-btn {
      background: #2e7d32;
      color: #fff;
      padding: 0.9rem 2rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 700;
      font-size: 1rem;
      margin-top: 1rem;
      transition: all 0.3s ease;
    }

    .retake-btn:hover {
      background: #1b4620;
      transform: translateY(-2px);
    }

    /* Result Map Legend */
    .result-legend {
      font-size: 0.85rem;
      color: #666;
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid #e0e0e0;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.4rem 0;
      justify-content: center;
    }

    .legend-box {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 2px solid;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    /* Loading Spinner Animation */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5000;
      animation: fadeIn 0.3s ease;
      backdrop-filter: blur(4px);
    }

    .loading-spinner {
      width: 80px;
      height: 80px;
      border: 8px solid rgba(255, 255, 255, 0.2);
      border-top: 8px solid #4caf50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loading-text {
      position: fixed;
      top: 55%;
      left: 50%;
      transform: translateX(-50%);
      color: #fff;
      font-size: 1.2rem;
      font-weight: 600;
      text-align: center;
      white-space: nowrap;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      z-index: 5001;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .split-screen-wrapper {
        flex-direction: column;
      }

      .main-stage {
        flex: 1 1 100%;
      }

      .question-navigator {
        flex: 0 1 auto;
        max-height: auto;
      }

      .navigator-grid {
        grid-template-columns: repeat(6, 1fr);
        max-width: 500px;
        margin: 0 auto;
      }
    }

    @media (max-width: 768px) {
      .split-screen-wrapper {
        padding: 0.5rem;
      }

      .main-stage {
        padding: 1rem;
      }

      .question-navigator {
        padding: 1rem;
      }

      .navigator-grid {
        grid-template-columns: repeat(5, 1fr);
      }

      .summary-stats {
        grid-template-columns: 1fr;
      }
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Floating Security Shapes Background -->
  <div class="bg-shapes">
    <!-- Lock Icon -->
    <svg class="floating-shape shape-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" color="#2e7d32">
      <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
      <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
    </svg>
    
    <!-- Shield Icon -->
    <svg class="floating-shape shape-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" color="#2e7d32">
      <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
    </svg>

    <!-- Hexagon Pattern -->
    <svg class="floating-shape shape-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" color="#2e7d32">
      <path d="M21 16.04c0 .537-.292 1.034-.761 1.3l-5.646 3.686a2.25 2.25 0 0 1-2.386 0L6.76 17.34A2.25 2.25 0 0 1 6 16.04V7.96c0-.537.292-1.034.761-1.3l5.646-3.686a2.25 2.25 0 0 1 2.386 0l5.646 3.686c.469.266.761.763.761 1.3v8.08z"></path>
    </svg>

    <!-- Lock Icon (Different shade) -->
    <svg class="floating-shape shape-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" color="#2e7d32">
      <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
      <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
    </svg>

    <!-- Shield Icon (Different shade) -->
    <svg class="floating-shape shape-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" color="#2e7d32">
      <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
    </svg>

    <!-- Hexagon Pattern (Different shade) -->
    <svg class="floating-shape shape-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" color="#2e7d32">
      <path d="M21 16.04c0 .537-.292 1.034-.761 1.3l-5.646 3.686a2.25 2.25 0 0 1-2.386 0L6.76 17.34A2.25 2.25 0 0 1 6 16.04V7.96c0-.537.292-1.034.761-1.3l5.646-3.686a2.25 2.25 0 0 1 2.386 0l5.646 3.686c.469.266.761.763.761 1.3v8.08z"></path>
    </svg>

    <!-- Lock Icon (Small) -->
    <svg class="floating-shape shape-7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" color="#2e7d32">
      <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
      <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
    </svg>

    <!-- Shield Icon (Small) -->
    <svg class="floating-shape shape-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" color="#2e7d32">
      <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
    </svg>
  </div>

  <!-- FDC Logo in Navbar -->
  <a href="https://www.fdcindia.com/" target="_blank" class="fdc-logo-nav" id="fdcLogoLink" title="Visit FDC India">
    <img src="favicon-green.svg" alt="FDC Logo" class="fdc-logo-svg" />
  </a>

  <a href="index.html" class="home-icon" id="homeIcon" title="Back to Home">
    <i class="fas fa-home"></i>
  </a>
  
  <canvas id="matrix"></canvas>

  <!-- Employee Information Form -->
  <div class="quiz-container" id="employeeForm">
    <h1>Employee Login</h1>
    <form onsubmit="startQuiz(event)" id="empForm">
      <div style="margin-bottom: 0.8rem;">
        <label style="display: block; margin-bottom: 0.4rem; color: #2e7d32; font-weight: 700;">Employee Email ID (FDC)</label>
        <input type="email" id="employeeEmail" placeholder="yourname@fdcindia.com" required style="width: 100%; padding: 0.8rem; border: 1px solid #2e7d32; border-radius: 6px; font-size: 1rem; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
      </div>
      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.4rem; color: #2e7d32; font-weight: 700;">Host ID (refer IPMsg)</label>
        <input type="text" id="employeeId" placeholder="Enter your Host ID (e.g., J-IT-003)" required style="width: 100%; padding: 0.8rem; border: 1px solid #2e7d32; border-radius: 6px; font-size: 1rem; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
      </div>
      <div id="verificationMessage" style="margin-bottom: 1rem; padding: 0.8rem; border-radius: 6px; display: none;"></div>
      <button type="submit" style="width: 100%; padding: 0.8rem; background: #2e7d32; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">Start Quiz</button>
      <a href="index.html" class="back-home-btn-quiz">Back to Home</a>
    </form>
    <!-- Copyright Footer -->
    <div class="copyright-footer" id="copyrightFooter">
      Copyright ¬© 2025 FDC | All Rights Reserved.
    </div>
  </div>

  <!-- Split Screen Quiz Interface -->
  <div class="split-screen-wrapper" id="quizWrapper" style="display: none;">
    
    <!-- Main Question Stage (Left Panel - 70%) -->
    <div class="main-stage" id="mainStage">
      <div class="timer-section">
        <div class="progress-info">
          Question <span id="currentQuestion">1</span> of <span id="totalQuestions">10</span>
        </div>
      </div>

      <div class="question-content" id="questionContent">
        <!-- Question will be inserted here -->
      </div>

      <div class="control-buttons">
        <button class="btn-nav" id="prevBtn" onclick="previousQuestion()" type="button">‚Üê Previous</button>
        <button class="btn-clear" id="clearBtn" onclick="clearOption()" type="button">Clear</button>
        <button class="btn-nav" id="nextBtn" onclick="nextQuestion()" type="button">Next ‚Üí</button>
        <button class="btn-submit" id="submitBtn" onclick="submitQuiz()" type="button" style="display: none; flex: 1; padding: 0.7rem 1.5rem;">
          <i class="fas fa-check-circle"></i> Submit Quiz
        </button>
      </div>
    </div>

    <!-- Question Navigator (Right Panel - 30%) -->
    <div class="question-navigator" id="navigator">
      <div class="navigator-header">Question Navigator</div>
      <div class="navigator-grid" id="navigatorGrid">
        <!-- Question buttons will be generated here -->
      </div>
      <button class="btn-submit-navigator" id="submitNavBtn" onclick="submitQuizFromNavigator()" type="button">
        Submit Quiz
      </button>
      <button class="btn-exit" onclick="exitQuiz()" type="button">Exit Quiz</button>
    </div>
  </div>

  <script>
    // Default questions (fallback if not modified by admin)
    const DEFAULT_QUIZ_QUESTIONS = [];

    // Load and merge all questions (default + custom)
    // Initialize questions - will be set by async loader
    let questions = [];

    // Function to load questions from Firebase or localStorage
    async function initializeAllQuestions() {
      // Try to fetch custom questions from Firebase first
      if (window.fetchCustomQuestionsFromFirebase) {
        try {
          const firebaseQuestions = await window.fetchCustomQuestionsFromFirebase();
          if (firebaseQuestions && firebaseQuestions.length > 0) {
            console.log("‚úÖ Fetched", firebaseQuestions.length, "questions from Firebase");
            // Save to localStorage for offline access
            localStorage.setItem('customQuestions', JSON.stringify(firebaseQuestions));
            questions = firebaseQuestions;
            console.log("üìä Quiz initialized with Firebase questions:", questions.length);
            return firebaseQuestions;
          }
        } catch (err) {
          console.warn("‚ö†Ô∏è Error fetching from Firebase:", err);
        }
      }

      // If Firebase didn't work, try loading from localStorage
      const storedCustom = localStorage.getItem('customQuestions');
      if (storedCustom) {
        try {
          let customQuestions = JSON.parse(storedCustom);
          console.log("üì¶ Loaded", customQuestions.length, "questions from localStorage");
          // Remove duplicates
          const uniqueMap = new Map();
          customQuestions.forEach(q => {
            if (!uniqueMap.has(q.id)) {
              uniqueMap.set(q.id, q);
            }
          });
          const uniqueQuestions = Array.from(uniqueMap.values());
          console.log("After deduplication:", uniqueQuestions.length, "unique questions");
          if (uniqueQuestions.length > 0) {
            questions = uniqueQuestions;
            console.log("üìä Quiz initialized with localStorage questions:", questions.length);
            return uniqueQuestions;
          }
        } catch (e) {
          console.warn("Error parsing localStorage questions", e);
        }
      }

      // Default questions for deployment (fallback)
      const defaultQuestions = [
        {
          id: "q1",
          q: "What is phishing?",
          options: [
            "A type of fishing technique",
            "A fraudulent attempt to obtain sensitive information by disguising communication as trustworthy source",
            "A programming language",
            "A social media platform"
          ],
          answer: 1,
          image: ""
        },
        {
          id: "q2",
          q: "Which of the following is NOT a common phishing method?",
          options: [
            "Fake email from your bank asking to verify account details",
            "SMS messages asking you to click a link",
            "Sending official company announcement through verified channels",
            "Pop-up windows asking for personal information"
          ],
          answer: 2,
          image: ""
        },
        {
          id: "q3",
          q: "What should you do if you receive a suspicious email asking for your password?",
          options: [
            "Reply with your password to confirm your account",
            "Click the link to verify",
            "Delete the email and report it to your IT department",
            "Forward it to all your colleagues"
          ],
          answer: 2,
          image: ""
        },
        {
          id: "q4",
          q: "How can you identify a phishing email?",
          options: [
            "Check the sender's email address carefully",
            "Look for spelling and grammar errors",
            "Check if links match the stated domain",
            "All of the above"
          ],
          answer: 3,
          image: ""
        },
        {
          id: "q5",
          q: "What is the safest way to check if a link is legitimate?",
          options: [
            "Hover over the link to see the URL",
            "Click it and then go back if it looks wrong",
            "Ask a colleague to click it first",
            "Always assume it's safe if it looks professional"
          ],
          answer: 0,
          image: ""
        },
        {
          id: "q6",
          q: "Which organization should you contact if you suspect a phishing attempt targeting your company?",
          options: [
            "The police immediately",
            "Your IT/Security department",
            "The sender of the email",
            "Social media"
          ],
          answer: 1,
          image: ""
        },
        {
          id: "q7",
          q: "What is two-factor authentication (2FA)?",
          options: [
            "Entering your password twice",
            "An additional security layer requiring a second verification method beyond password",
            "Having two email accounts",
            "Using two different browsers"
          ],
          answer: 1,
          image: ""
        },
        {
          id: "q8",
          q: "How often should you change your passwords?",
          options: [
            "Once a year",
            "Every 3-6 months or immediately if compromised",
            "Never, keep the same password",
            "Every time you log in"
          ],
          answer: 1,
          image: ""
        },
        {
          id: "q9",
          q: "What is a credential stuffing attack?",
          options: [
            "Hiding credentials in a bag",
            "Using stolen passwords from one breach to access multiple accounts",
            "A type of food storage",
            "Interviewing candidates for a job"
          ],
          answer: 1,
          image: ""
        },
        {
          id: "q10",
          q: "What should be your response if you accidentally click a phishing link?",
          options: [
            "Ignore it and do nothing",
            "Immediately change your password and notify your IT department",
            "Forward the email to your friends",
            "Check if your data was stolen online"
          ],
          answer: 1,
          image: ""
        }
      ];

      // Use default questions as fallback
      console.log("‚ÑπÔ∏è Using default fallback questions:", defaultQuestions.length);
      questions = defaultQuestions;
      console.log("üìä Quiz initialized with default questions:", questions.length);
      return defaultQuestions;
    }

    // Employee Database for Verification - Email based authentication
    const employeeDatabase = {
      "sankat@fdcindia.com": { name: "Sankat", hostId: "J-IT-003", group: "IT Dept" },
      "anant.pandye@fdcindia.com": { name: "Anant Pandye", hostId: "J-IT-229", group: "IT Dept" },
      "atharva.more@fdcindia.com": { name: "Atharva More", hostId: "J-IT-018", group: "IT Dept" },
      "brijesh.jaiswal@fdcindia.com": { name: "Brijesh Jaiswal", hostId: "A-IT-005", group: "IT Dept" },
      "gaurav.w@fdcindia.com": { name: "Gaurav W", hostId: "J-IT-011", group: "IT Dept" },
      "kalpesh.shah@fdcindia.com": { name: "Kalpesh Shah", hostId: "A-IT-001", group: "IT Dept" },
      "kishor.dalvi@fdcindia.com": { name: "Kishor Dalvi", hostId: "J-IT-019", group: "IT Dept" },
      "pawan.singh@fdcindia.com": { name: "Pawan Singh", hostId: "A-IT-006", group: "IT Dept" },
      "payal.lohar@fdcindia.com": { name: "Payal Lohar", hostId: "A-IT-007", group: "IT Dept" },
      "pragesh.mayekar@fdcindia.com": { name: "Pragesh Mayekar", hostId: "A-IT-009", group: "IT Dept" },
      "rajesh.nikharge@fdcindia.com": { name: "Rajesh Nikharge", hostId: "J-IT-014", group: "IT Dept" },
      "shailesh.kudu@fdcindia.com": { name: "Shailesh Kudu", hostId: "J-IT-008", group: "IT Dept" },
      "sumit.rame@fdcindia.com": { name: "Sumit Rame", hostId: "A-IT-002", group: "IT Dept" },
      "swarna.chennakesavulu@fdcindia.com": { name: "Swarna Chennakesavulu", hostId: "J-IT-020", group: "IT Dept" },
      "uday.shukla@fdcindia.com": { name: "Uday Shukla", hostId: "A-IT-004", group: "IT Dept" },
      "unnati.patel@fdcindia.com": { name: "Unnati Patel", hostId: "A-IT-015", group: "IT Dept" },
      "vijith.pinarayi@fdcindia.com": { name: "Vijith (Viji Pinarayi)", hostId: "J-IT-004", group: "IT Dept" },
      "yogesh.yadav@fdcindia.com": { name: "Yogesh Yadav", hostId: "J-IT-013", group: "IT Dept" },
      "abhijit.jadhav@fdcindia.com": { name: "Abhijit Jadhav", hostId: "J-PUR-010", group: "PURCHASE" },
      "kishor.satam@fdcindia.com": { name: "Kishor Satam", hostId: "J-PUR-003", group: "PURCHASE" },
      "kharayan.thive@fdcindia.com": { name: "Kharayan Thive", hostId: "J-PUR-006", group: "PURCHASE" },
      "nidhi.gode@fdcindia.com": { name: "Nidhi Gode", hostId: "A-PUR-012", group: "PURCHASE" },
      "pranod.karolkar@fdcindia.com": { name: "Pranod Karolkar", hostId: "J-PUR-017", group: "PURCHASE" },
      "ranjana.sondagar@fdcindia.com": { name: "Ranjana Sondagar", hostId: "J-PUR-016", group: "PURCHASE" },
      "ravindra.panchal@fdcindia.com": { name: "Ravindra Panchal", hostId: "J-PUR-020", group: "PURCHASE" },
      "shrikant.gaile@fdcindia.com": { name: "Shrikant Gaile", hostId: "A-PUR-021", group: "PURCHASE" },
      "vijay.jadhav@fdcindia.com": { name: "Vijay Jadhav", hostId: "K-ARDL-003", group: "ARDL" },
      "anupama.yadav@fdcindia.com": { name: "Anupama Yadav", hostId: "J-DOC-007", group: "ARDL3 Doc." },
      "rupesh.kelaskar@fdcindia.com": { name: "Rupesh Kelaskar", hostId: "J-QA-012", group: "ARDL3 Doc." },
      "anand.nestly@fdcindia.com": { name: "Anand Nestly", hostId: "J-ART-007", group: "ART" },
      "jayvant.hire@fdcindia.com": { name: "Jayvant Hire", hostId: "J-ART-006", group: "ART" },
      "neeta.dalvi@fdcindia.com": { name: "Neeta Dalvi", hostId: "J-ART-008", group: "ART" },
      "pooja.desai@fdcindia.com": { name: "Pooja Desai", hostId: "J-ART-009", group: "ART" },
      "ravindra.mulam@fdcindia.com": { name: "RAVindra Mulam", hostId: "J-ART-001", group: "ART" },
      "sameer.jadhav@fdcindia.com": { name: "Sameer Jadhav", hostId: "J-ART-002", group: "ART" },
      "suhas.kadam@fdcindia.com": { name: "Suhas Kadam", hostId: "J-ART-003", group: "ART" },
      "varsha.yeram@fdcindia.com": { name: "Varsha Yeram", hostId: "J-ART-005", group: "ART" },
      "akash.chaurasia@fdcindia.com": { name: "Akash Chaurasia", hostId: "J-ACC-002", group: "ACCOUNTS" },
      "shamal.bandivadekar@fdcindia.com": { name: "Shamal Bandivadekar Extn", hostId: "A-ACC-034", group: "ACCOUNTS" },
      "yash.thakur@fdcindia.com": { name: "Yash Thakur", hostId: "J-BITC-011", group: "BIOTECH" },
      "abhijeet.shinde@fdcindia.com": { name: "Abhijeet Shinde", hostId: "A-QA-001", group: "CQA" },
      "amol.rohakale@fdcindia.com": { name: "Amol Rohakale", hostId: "A-QA-009", group: "CQA" },
      "atul.sawangikar@fdcindia.com": { name: "Atul Sawangikar", hostId: "J-QA-014", group: "CQA" },
      "bhushan.kolake@fdcindia.com": { name: "Bhushan Kolake", hostId: "J-QA-005", group: "CQA" },
      "dattu.kolekar@fdcindia.com": { name: "Dattu Kolekar", hostId: "J-QA-008", group: "CQA" },
      "deepak.satam@fdcindia.com": { name: "Deepak Satam", hostId: "J-QA-019", group: "CQA" },
      "dinesh.yadav@fdcindia.com": { name: "Dinesh Yadav", hostId: "A-QA-004", group: "CQA" },
      "ganesh.chothe@fdcindia.com": { name: "Ganesh Chotthe", hostId: "J-QA-021", group: "CQA" },
      "jitendra.thakur@fdcindia.com": { name: "Jitendra Thakur", hostId: "A-QA-013", group: "CQA" },
      "lalit.narkhede@fdcindia.com": { name: "Lalit Narkhede", hostId: "J-QA-015", group: "CQA" },
      "nitin.naik@fdcindia.com": { name: "Nitin Naik", hostId: "J-QA-024", group: "CQA" },
      "rahul.galaye@fdcindia.com": { name: "Rahul Galaye", hostId: "J-QA-023", group: "CQA" },
      "saket.rane@fdcindia.com": { name: "Saket Rane", hostId: "A-QA-017", group: "CQA" },
      "shrinivas.gharat@fdcindia.com": { name: "Shrinivas Gharat", hostId: "J-QA-011", group: "CQA" },
      "prashant.chadgaonkar@fdcindia.com": { name: "Prashant Chadgaonkar", hostId: "J-QA-006", group: "CQA" },
      "ajay.singh@fdcindia.com": { name: "Ajay Singh", hostId: "J-QA-003", group: "CQC" },
      "m.sundaram@fdcindia.com": { name: "M Sundaram", hostId: "J-QA-018", group: "CQC" },
      "nilesh.terdalkar@fdcindia.com": { name: "Nilesh Terdaikar", hostId: "J-QA-020", group: "CQC" },
      "sarvesh.bane@fdcindia.com": { name: "Sarvesh Bane", hostId: "J-QA-022", group: "CQC" },
      "archana.rawool@fdcindia.com": { name: "Archana Rawool", hostId: "J-DIS-008", group: "Distribution" },
      "bhavna.rana@fdcindia.com": { name: "Bhavna Rana", hostId: "A-DIS-007", group: "Distribution" },
      "kavita.panchal@fdcindia.com": { name: "Kavita Panchal", hostId: "A-DIS-001", group: "Distribution" },
      "manjiri.alve@fdcindia.com": { name: "Manjiri Alve", hostId: "J-EXP-003", group: "Distribution" },
      "om.tuvrekar@fdcindia.com": { name: "Om Tuvrekar", hostId: "J-DIS-006", group: "Distribution" },
      "prach.ghadi@fdcindia.com": { name: "Prach Ghadi", hostId: "J-EXP-005", group: "Distribution" },
      "prajita.patel@fdcindia.com": { name: "Prajita Patel", hostId: "J-DIS-002", group: "Distribution" },
      "rahul.dalvi@fdcindia.com": { name: "Rahul Dalvi", hostId: "A-DIS-017", group: "Distribution" },
      "rishi.nalkswadi@fdcindia.com": { name: "Rishi Nalkswadi", hostId: "J-DIS-014", group: "Distribution" },
      "sachin.borase@fdcindia.com": { name: "Sachin Borase", hostId: "A-DIS-015", group: "Distribution" },
      "sheetal.bhatale@fdcindia.com": { name: "Sheetai Bhatale", hostId: "J-DIS-013", group: "Distribution" },
      "shivaji.nalawade@fdcindia.com": { name: "Shivaji Nalawade", hostId: "J-DIS-011", group: "Distribution" },
      "shrutika.more@fdcindia.com": { name: "Shrutika More", hostId: "J-DIS-016", group: "Distribution" },
      "sushant.patkar@fdcindia.com": { name: "Sushant Patkar", hostId: "J-DIS-010", group: "Distribution" },
      "yogesh.sawant@fdcindia.com": { name: "Yogesh N Sawant Ext", hostId: "J-DIS-005", group: "Distribution" },
      "dipali.devekar@fdcindia.com": { name: "Dipali Devekar", hostId: "J-DOC-008", group: "Documentation" },
      "kanchan.gavand@fdcindia.com": { name: "Kanchan Gavand", hostId: "J-DOC-010", group: "Documentation" },
      "ketaki.khandewale@fdcindia.com": { name: "Ketaki Khandewaie", hostId: "J-DOC-009", group: "Documentation" },
      "surekha.lande@fdcindia.com": { name: "Surekha Lande", hostId: "J-DOC-004", group: "Documentation" },
      "tushar.d@fdcindia.com": { name: "Tushar D", hostId: "J-DOC-001", group: "Documentation" },
      "umika.pavaskar@fdcindia.com": { name: "Umika Pavaskar", hostId: "A-DOC-005", group: "Documentation" },
      "utpala.lalit@fdcindia.com": { name: "Utpala Lalit", hostId: "J-DOC-003", group: "Documentation" },
      "hemali.pelu@fdcindia.com": { name: "Hemali Pelu", hostId: "J-EXP-012", group: "Export (Formulations)" },
      "jaswinder.gill@fdcindia.com": { name: "Jaswinder Gill", hostId: "J-EXP-009", group: "Export (Formulations)" },
      "kaipesh.atul@fdcindia.com": { name: "Kaipesh Atul", hostId: "A-EXP-010", group: "Export (Formulations)" },
      "krupali.sanghvi@fdcindia.com": { name: "Krupali Sanghvi", hostId: "J-EXP-015", group: "Export (Formulations)" },
      "nahid.risaldar@fdcindia.com": { name: "Nahid Risaldar", hostId: "J-EXP-017", group: "Export (Formulations)" },
      "nishant.meshram@fdcindia.com": { name: "Nishant Meshram", hostId: "A-EXP-011", group: "Export (Formulations)" },
      "rajesh.khambal@fdcindia.com": { name: "Rajesh Khambal", hostId: "J-EXP-016", group: "Export (Formulations)" },
      "shner.surte@fdcindia.com": { name: "Shner Surte", hostId: "J-EXP-014", group: "Export (Formulations)" },
      "sandeep.hegde@fdcindia.com": { name: "Sandeep Hegde", hostId: "A-EXP-019", group: "Export (Formulations)" },
      "sanjivani.chandorkar@fdcindia.com": { name: "Sanjivani Chandorkar", hostId: "A-EXP-018", group: "Export (Formulations)" },
      "vinod.asif@fdcindia.com": { name: "Vinod Asif", hostId: "A-EXP-007", group: "Export (Formulations)" },
      "sameer.sawant@fdcindia.com": { name: "Sameer Sawant", hostId: "A-EXP-008", group: "Export (International)" },
      "abhay.raut@fdcindia.com": { name: "Abhay Raut", hostId: "J-HR-021", group: "HR" },
      "arpita.sahu@fdcindia.com": { name: "Arpita Sahu", hostId: "J-HR-012", group: "HR" },
      "ganesh.joshi@fdcindia.com": { name: "Ganesh Joshi", hostId: "J-HR-029", group: "HR" },
      "jyoti.nayak@fdcindia.com": { name: "Jyoti Nayak", hostId: "J-SA-012", group: "HR" },
      "kerry.barrowe@fdcindia.com": { name: "Kerry Barrowe", hostId: "J-HR-004", group: "HR" },
      "kiran.kadam@fdcindia.com": { name: "Kiran Kadam", hostId: "J-HR-023", group: "HR" },
      "mangesh.malusare@fdcindia.com": { name: "Mangesh Malusare", hostId: "J-HR-002", group: "HR" },
      "manoj.shetty@fdcindia.com": { name: "Manoj Shetty", hostId: "J-HR-003", group: "HR" },
      "maruti.bachantti@fdcindia.com": { name: "Maruti Bachantti", hostId: "J-HR-014", group: "HR" },
      "neha.malik@fdcindia.com": { name: "Neha Malik", hostId: "J-HR-018", group: "HR" },
      "pallavi.bane@fdcindia.com": { name: "Pallavi Bane", hostId: "J-SA-013", group: "HR" },
      "pankaj.agare@fdcindia.com": { name: "Pankaj Agare", hostId: "J-HR-019", group: "HR" },
      "pradeep.dalvi@fdcindia.com": { name: "Pradeep Dalvi", hostId: "J-HR-026", group: "HR" },
      "pramesh.rajput@fdcindia.com": { name: "Pramesh Rajput", hostId: "J-HR-022", group: "HR" },
      "pravin.vishram@fdcindia.com": { name: "Pravin Vishram", hostId: "J-HR-006", group: "HR" },
      "raj.bhagwat@fdcindia.com": { name: "Raj Bhagwat", hostId: "J-HR-015", group: "HR" },
      "raj.salpal@fdcindia.com": { name: "Raj Salpal", hostId: "J-HR-025", group: "HR" },
      "tejas.pavaskar@fdcindia.com": { name: "Tejas Pavaskar", hostId: "J-HR-013", group: "HR" },
      "uday.jadhay@fdcindia.com": { name: "Uday Jadhay", hostId: "A-HR-005", group: "HR" },
      "vinay.halide@fdcindia.com": { name: "Vinay Halide", hostId: "J-HR-001", group: "HR" },
      "vivek.joshi@fdcindia.com": { name: "Vivek Joshi", hostId: "J-HR-007", group: "HR" },
      "yogesh.patil@fdcindia.com": { name: "Yogesh Patil", hostId: "J-HR-010", group: "HR" },
      "atish.raut@fdcindia.com": { name: "Atish Raut", hostId: "A-IPR-003", group: "IPR" },
      "prachi.jadhav@fdcindia.com": { name: "Prachi Jadhav", hostId: "J-EXP-010", group: "IPR" },
      "gyanand.singh@fdcindia.com": { name: "Gyanand Singh", hostId: "J-LEG-006", group: "LEGAL" },
      "mayank.jain@fdcindia.com": { name: "Mayank Jain", hostId: "J-LEG-004", group: "LEGAL" },
      "sujata.parab@fdcindia.com": { name: "Sujata Parab", hostId: "J-LEG-002", group: "LEGAL" },
      "vasharani.katre@fdcindia.com": { name: "Vasharani Katre", hostId: "A-LEG-001", group: "LEGAL" },
      "bhavya.rajan@fdcindia.com": { name: "Bhavya Rajan", hostId: "J-MDL-004", group: "MDL" },
      "kalpesh.dalvi@fdcindia.com": { name: "Dr. Kalpesh Dalvi", hostId: "J-MDL-006", group: "MDL" },
      "gopal.kadam@fdcindia.com": { name: "Gopal Kadam", hostId: "A-MDL-005", group: "MDL" },
      "nitin.kachhava@fdcindia.com": { name: "Nitin Kachhava", hostId: "A-MDL-007", group: "MDL" },
      "prajakta.raje@fdcindia.com": { name: "Prajalta Raje", hostId: "A-IPR-002", group: "MDL" },
      "smita.prajapati@fdcindia.com": { name: "Smita Prajapati", hostId: "J-MDL-001", group: "MDL" },
      "saloni.jadhav@fdcindia.com": { name: "SALONI JADHAV", hostId: "J-BITC-012", group: "MTL" },
      "praveen.khadse@fdcindia.com": { name: "Praveen Khadse", hostId: "J-MAT-005", group: "Maintenance" },
      "prisan.khan@fdcindia.com": { name: "Prisan Khan", hostId: "J-MAT-003", group: "Maintenance" },
      "rohan.pawar@fdcindia.com": { name: "Rohan Pawar", hostId: "J-MAT-006", group: "Maintenance" },
      "sachin.zolekar@fdcindia.com": { name: "Sachin Zolekar", hostId: "A-MAT-001", group: "Maintenance" },
      "vishal.kapre@fdcindia.com": { name: "Vishal Kapre", hostId: "J-MAT-007", group: "Maintenance" },
      "yogesh.zope@fdcindia.com": { name: "Yogesh Zope", hostId: "J-MAT-011", group: "Maintenance" },
      "abhinav.singh@fdcindia.com": { name: "Abhinav Singh", hostId: "J-MKT-020", group: "Marketing" },
      "akharya.rathod@fdcindia.com": { name: "Akharya Rathod", hostId: "J-MKT-011", group: "Marketing" },
      "aleeza.biswal@fdcindia.com": { name: "Aleeza Biswal", hostId: "J-MKT-025", group: "Marketing" },
      "amit.khachane@fdcindia.com": { name: "Amit Khachane", hostId: "A-MKT-012", group: "Marketing" },
      "anand.jaiswar@fdcindia.com": { name: "Anand Jaiswar", hostId: "J-MKT-019", group: "Marketing" },
      "ankur.gautam@fdcindia.com": { name: "Ankur Gautam", hostId: "J-MKT-038", group: "Marketing" },
      "bharat.mohan@fdcindia.com": { name: "Bharat Mohan", hostId: "A-MKT-024", group: "Marketing" },
      "deepika.kadam@fdcindia.com": { name: "Deepika Kadam", hostId: "J-MKT-056", group: "Marketing" },
      "dilip.patil@fdcindia.com": { name: "Dilip Patil", hostId: "J-MKT-021", group: "Marketing" },
      "dipti.patil@fdcindia.com": { name: "Dipti Patil", hostId: "J-MKT-046", group: "Marketing" },
      "gajanan.barde@fdcindia.com": { name: "Gajanan Barde", hostId: "A-MKT-067", group: "Marketing" },
      "jyoti.barde@fdcindia.com": { name: "Jyoti Barde", hostId: "A-MKT-068", group: "Marketing" },
      "kunal.vishnuwardhan@fdcindia.com": { name: "Kunal Vishnuwardhan", hostId: "J-MKT-040", group: "Marketing" },
      "mandar.bivalkar@fdcindia.com": { name: "Mandar Bivaikar", hostId: "J-MKT-047", group: "Marketing" },
      "mandar.rane@fdcindia.com": { name: "Mandar Rame", hostId: "J-MKT-009", group: "Marketing" },
      "megha.menon@fdcindia.com": { name: "Megha Menon", hostId: "J-MKT-013", group: "Marketing" },
      "meghavi.gandhi@fdcindia.com": { name: "Meghavi Gandhi", hostId: "J-MKT-014", group: "Marketing" },
      "nidhi.mishra@fdcindia.com": { name: "Nidhi Mishra", hostId: "J-MKT-031", group: "Marketing" },
      "nilam.bhor@fdcindia.com": { name: "Nilam Bhor", hostId: "A-MKT-027", group: "Marketing" },
      "nkifer.bothera@fdcindia.com": { name: "Nkifer Bothera", hostId: "J-MKT-005", group: "Marketing" },
      "pooja.gupta@fdcindia.com": { name: "Pooja Gupta", hostId: "J-MKT-008", group: "Marketing" },
      "pramod.ghaytidak@fdcindia.com": { name: "Pramod Ghaytdak", hostId: "J-MKT-035", group: "Marketing" },
      "priya.khodape@fdcindia.com": { name: "Priya Khodape", hostId: "J-MKT-066", group: "Marketing" },
      "ravindra.upadhyay@fdcindia.com": { name: "Ravindra Upadhyay", hostId: "A-MKT-043", group: "Marketing" },
      "rupesh.kumar@fdcindia.com": { name: "Rupesh Kumar", hostId: "J-MKT-018", group: "Marketing" },
      "sachin.sakunde@fdcindia.com": { name: "Sachin Sakunde", hostId: "J-MKT-007", group: "Marketing" },
      "satish.kamble@fdcindia.com": { name: "Satish Kamble", hostId: "J-MKT-036", group: "Marketing" },
      "sandeep.arora@fdcindia.com": { name: "Sandeep Arora", hostId: "J-MKT-022", group: "Marketing" },
      "santosh.ranade@fdcindia.com": { name: "Santosh Ranade", hostId: "J-MKT-060", group: "Marketing" },
      "sapika.pujari@fdcindia.com": { name: "Sapika Pujari", hostId: "J-MKT-028", group: "Marketing" },
      "shoaib.khan@fdcindia.com": { name: "Shoaib Khan", hostId: "A-MKT-033", group: "Marketing" },
      "shrikant.bochare@fdcindia.com": { name: "Shrikant Bochare", hostId: "J-MKT-006", group: "Marketing" },
      "sudarshan.337@fdcindia.com": { name: "Sudarsahn @337", hostId: "J-MKT-026", group: "Marketing" },
      "supriya.naik@fdcindia.com": { name: "Supriya Naik@155", hostId: "A-MKT-002", group: "Marketing" },
      "sushant.naik@fdcindia.com": { name: "Sushant Naik", hostId: "J-MKT-039", group: "Marketing" },
      "vaibhav.mantra@fdcindia.com": { name: "Vaibhav Mantra", hostId: "A-MKT-004", group: "Marketing" },
      "vidya.pawar@fdcindia.com": { name: "Vidya Pawar", hostId: "J-MKT-003", group: "Marketing" },
      "vijay.gupta@fdcindia.com": { name: "Vijay Gupta", hostId: "A-MKT-054", group: "Marketing" },
      "vijesh.pai@fdcindia.com": { name: "Vijesh Pai", hostId: "J-MKT-034", group: "Marketing" },
      "vishakha.ghadigaonkar@fdcindia.com": { name: "Vishakha Ghadigaonkar", hostId: "J-MKT-063", group: "Marketing" },
      "nehali.monde@fdcindia.com": { name: "Nehal Monde", hostId: "A-PAC-011", group: "PACKAGING" },
      "nikee.belekar@fdcindia.com": { name: "Nikee Belekar", hostId: "J-PAC-002", group: "PACKAGING" },
      "nitin.more@fdcindia.com": { name: "Nitin More", hostId: "A-PAC-005", group: "PACKAGING" },
      "roshan.naik@fdcindia.com": { name: "Roshan Naik", hostId: "A-PAC-004", group: "PACKAGING" },
      "roshani.saalim@fdcindia.com": { name: "Roshani Saalim", hostId: "A-PAC-015", group: "PACKAGING" },
      "satap.sanap@fdcindia.com": { name: "Satap Sanap", hostId: "J-PAC-014", group: "PACKAGING" },
      "santosh.shinde@fdcindia.com": { name: "Santosh Shinde", hostId: "J-PAC-007", group: "PACKAGING" },
      "shailesh.jadhay@fdcindia.com": { name: "Shailesh Jadhay", hostId: "J-PAC-009", group: "PACKAGING" },
      "tejal.mohite@fdcindia.com": { name: "Tejal Mohite", hostId: "J-PAC-010", group: "PACKAGING" },
      "tripti.nakahre@fdcindia.com": { name: "Tripti Nakahre", hostId: "J-PAC-001", group: "PACKAGING" },
      "vipin.gharge@fdcindia.com": { name: "Vipin Gharge", hostId: "J-PAC-006", group: "PACKAGING" },
      "anj.sawant@fdcindia.com": { name: "Anj Sawant", hostId: "J-PAC-008", group: "Packaging" },
      "aman.chaturvedi@fdcindia.com": { name: "Aman Chaturvedi", hostId: "J-PLA-014", group: "PLANNING" },
      "amolb.shelar@fdcindia.com": { name: "Amol Shelar", hostId: "A-PLA-005", group: "PLANNING" },
      "anildarekar@fdcindia.com": { name: "Anil Darekar", hostId: "J-PLA-006", group: "PLANNING" },
      "kishor.mhatre@fdcindia.com": { name: "Kishor Mhatre", hostId: "J-PLA-004", group: "PLANNING" },
      "mangesh.karanjekar@fdcindia.com": { name: "Mangesh Karanjekar", hostId: "J-PLA-001", group: "PLANNING" },
      "shashank.wapan@fdcindia.com": { name: "Shashank Wapan", hostId: "J-PLA-010", group: "PLANNING" },
      "siddhesh.patil@fdcindia.com": { name: "Siddhesh Patil", hostId: "A-PLA-015", group: "PLANNING" },
      "vijay.wagh@fdcindia.com": { name: "Vijay Wagh", hostId: "J-PLA-007", group: "PLANNING" },
      "amiket.dooarklr@fdcindia.com": { name: "Amiket Dooarklr", hostId: "J-PUR-011", group: "PURCHASE" },
      "avinash.bhute@fdcindia.com": { name: "Avinash Bhute", hostId: "J-PUR-001", group: "PURCHASE" },
      "bhavuk.chaudhari@fdcindia.com": { name: "Bhavuk Chaudhari", hostId: "J-PUR-022", group: "PURCHASE" },
      "dhiraj.patil@fdcindia.com": { name: "Dhiraj Patil", hostId: "A-PUR-014", group: "PURCHASE" },
      "mangesh.mane@fdcindia.com": { name: "Mangesh Mane", hostId: "J-PUR-015", group: "PURCHASE" },
      "nilesh.patil@fdcindia.com": { name: "Nilesh Patil", hostId: "J-PUR-008", group: "PURCHASE" },
      "nikesh.barot@fdcindia.com": { name: "Nikesh Barot", hostId: "J-PUR-004", group: "PURCHASE" },
      "prashant.dalvi@fdcindia.com": { name: "Prashant Dalvi", hostId: "J-PUR-018", group: "PURCHASE" },
      "sandeep.naik@fdcindia.com": { name: "Sandeep Naik", hostId: "J-PUR-005", group: "PURCHASE" },
      "sanjay.sawant@fdcindia.com": { name: "Sanjay Sawant", hostId: "J-PUR-019", group: "PURCHASE" },
      "tejal.mayekar@fdcindia.com": { name: "Tejal Mayekar", hostId: "J-PUR-002", group: "PURCHASE" },
      "ronak.barot@fdcindia.com": { name: "Ronak Barot", hostId: "J-PP-001", group: "Product Portfolio" },
      "deepak.dhodade@fdcindia.com": { name: "Deepak Dhoade LP", hostId: "J-FDS-001", group: "R&D foods" },
      "gopal.mule@fdcindia.com": { name: "Gopal Mule", hostId: "A-FDS-005", group: "R&D foods" },
      "sumit.somner@fdcindia.com": { name: "Sumit Somner@307", hostId: "J-FDS-003", group: "R&D foods" },
      "dnyaneshwar.k@fdcindia.com": { name: "Dnyaneshwar K", hostId: "J-RDF-023", group: "RDF" },
      "kalpesh.patil@fdcindia.com": { name: "KALPESH PATIL", hostId: "J-RDF-025", group: "RDF" },
      "umesh.gound@fdcindia.com": { name: "Umesh Gound", hostId: "J-RDF-037", group: "RDF" },
      "aniket.pacharne@fdcindia.com": { name: "Aniket Pacharne", hostId: "A-RA-024", group: "Regulatory Affairs" },
      "ashwini.meher@fdcindia.com": { name: "Ashwini Meher", hostId: "J-RA-017", group: "Regulatory Affairs" },
      "avani.sondagar@fdcindia.com": { name: "Avani Sondagar", hostId: "J-RA-004", group: "Regulatory Affairs" },
      "bhagyashree.patil@fdcindia.com": { name: "Bhagyashree Patil", hostId: "J-RA-010", group: "Regulatory Affairs" },
      "edyce.l@fdcindia.com": { name: "Edyce L", hostId: "J-RA-025", group: "Regulatory Affairs" },
      "hansa.chaudhary@fdcindia.com": { name: "Hansa Chaudhary", hostId: "J-RA-020", group: "Regulatory Affairs" },
      "mansi.hapaliya@fdcindia.com": { name: "Mansi Hapaliya", hostId: "A-RA-014", group: "Regulatory Affairs" },
      "mitali.naik@fdcindia.com": { name: "Mitali Naik", hostId: "A-RA-007", group: "Regulatory Affairs" },
      "neetu.sharma@fdcindia.com": { name: "Neetu Sharma", hostId: "J-RA-016", group: "Regulatory Affairs" },
      "poonam.shende@fdcindia.com": { name: "Poonam Shende", hostId: "J-RA-002", group: "Regulatory Affairs" },
      "prasanna.angane@fdcindia.com": { name: "Prasanna Angane", hostId: "J-RA-019", group: "Regulatory Affairs" },
      "pritam.debnath@fdcindia.com": { name: "Pritam Debnath", hostId: "J-RA-009", group: "Regulatory Affairs" },
      "pushkar.gupta@fdcindia.com": { name: "Pushkar Gupta@144", hostId: "J-RA-015", group: "Regulatory Affairs" },
      "rahul.patil@fdcindia.com": { name: "Rahul Patil", hostId: "A-RA-006", group: "Regulatory Affairs" },
      "rajesh.bhapkar@fdcindia.com": { name: "Rajesh Bhapkar", hostId: "J-RA-001", group: "Regulatory Affairs" },
      "riska.borate@fdcindia.com": { name: "Riska Borate", hostId: "J-RA-008", group: "Regulatory Affairs" },
      "shital.kadam@fdcindia.com": { name: "Shital Kadam", hostId: "A-RA-018", group: "Regulatory Affairs" },
      "shruti.sawant@fdcindia.com": { name: "Shruti Sawant", hostId: "J-RA-005", group: "Regulatory Affairs" },
      "sonali.sawant@fdcindia.com": { name: "Sonali Sawant", hostId: "J-RA-023", group: "Regulatory Affairs" },
      "subodh.singh@fdcindia.com": { name: "Subodh Singh", hostId: "A-MKT-051", group: "Regulatory Affairs" },
      "vishal.bodke@fdcindia.com": { name: "Vishal Bodke", hostId: "J-RA-011", group: "Regulatory Affairs" },
      "dinesh.chodankar@fdcindia.com": { name: "Dinesh Chodankar", hostId: "J-SFE-005", group: "SFE" },
      "niketan.ghadi@fdcindia.com": { name: "Niketan Ghadi", hostId: "J-SFE-004", group: "SFE" },
      "raghunath.pednekar@fdcindia.com": { name: "Raghunath Pednekar", hostId: "J-SFE-003", group: "SFE" },
      "sachin.alhat@fdcindia.com": { name: "Sachin Alhat", hostId: "J-SFE-007", group: "SFE" },
      "shashank.more@fdcindia.com": { name: "Shashank More", hostId: "A-SFE-002", group: "SFE" },
      "tanvi.yerunkar@fdcindia.com": { name: "Tanvi Yerunkar", hostId: "J-SFE-006", group: "SFE" },
      "ashwin.shah@fdcindia.com": { name: "Aashwin Shah", hostId: "A-STG-002", group: "STG" },
      "harshal.jain@fdcindia.com": { name: "Harshal Jain", hostId: "J-STG-003", group: "STG" },
      "jitendra.srivastava@fdcindia.com": { name: "Jitendra Srivastava", hostId: "A-STG-004", group: "STG" },
      "kiran.hode@fdcindia.com": { name: "kiran Hode", hostId: "J-STG-001", group: "STG" }
    };

    let currentQuestionIndex = 0;
    let userAnswers = new Array(questions.length).fill(null);
    let timerInterval;
    let timeRemaining = 60;
    let employeeName = '';
    let employeeGroup = '';
    let employeeId = '';
    let isQuizSubmitted = false;
    let isReviewMode = false;
    let submittedFromQuestionIndex = 0;
    let violationCount = 0;
    let isInFullscreen = false;
    let isInRecoveryMode = false;
    let resumingAfterViolation = false;
    let isReturningToVideo = false; // Track if user is coming back to rewatch video

    const questionContent = document.getElementById("questionContent");
    const currentQuestionSpan = document.getElementById("currentQuestion");
    const totalQuestionsSpan = document.getElementById("totalQuestions");
    const timerDisplay = document.getElementById("timer");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const submitBtn = document.getElementById("submitBtn");
    const clearBtn = document.getElementById("clearBtn");
    const mainStage = document.getElementById("mainStage");
    const navigator = document.getElementById("navigator");

    totalQuestionsSpan.textContent = questions.length;

    async function syncCustomQuestionsFromFirebase() {
      if (window.fetchCustomQuestionsFromFirebase) {
        try {
          const custom = await window.fetchCustomQuestionsFromFirebase();
          if (custom && custom.length > 0) {
            console.log("‚úÖ Firebase has", custom.length, "custom questions");
            // Save to localStorage for persistence
            localStorage.setItem('customQuestions', JSON.stringify(custom));
            // Update the questions array
            questions = custom;
            console.log("üíæ Saved Firebase questions to localStorage");
            console.log("üìä Quiz questions updated to:", questions.length);
          } else {
            console.log("‚ÑπÔ∏è No custom questions from Firebase");
          }
        } catch (err) {
          console.warn("‚ö†Ô∏è Firebase custom questions unavailable:", err);
        }
      } else {
        console.log("‚ÑπÔ∏è Firebase module not loaded");
      }
    }

    function startQuiz(event) {
      event.preventDefault();
      const employeeEmail = document.getElementById('employeeEmail').value.trim().toLowerCase();
      employeeId = document.getElementById('employeeId').value.trim();
      
      // Verify employee data
      const verificationMessage = document.getElementById('verificationMessage');
      
      console.log("Checking email:", employeeEmail);
      console.log("Checking hostId:", employeeId);
      console.log("Database keys sample:", Object.keys(employeeDatabase).slice(0, 5));
      
      if (!employeeDatabase[employeeEmail]) {
        verificationMessage.style.display = 'block';
        verificationMessage.style.background = '#ffebee';
        verificationMessage.style.color = '#c62828';
        verificationMessage.style.border = '1px solid #ef5350';
        verificationMessage.innerHTML = '<strong>‚ùå Email Not Found:</strong> The email address you entered is not in our database. Please check and try again.';
        return;
      }
      
      const employeeData = employeeDatabase[employeeEmail];
      console.log("Employee data found:", employeeData);
      
      if (employeeData.hostId !== employeeId) {
        verificationMessage.style.display = 'block';
        verificationMessage.style.background = '#ffebee';
        verificationMessage.style.color = '#c62828';
        verificationMessage.style.border = '1px solid #ef5350';
        verificationMessage.innerHTML = `‚ùå Host ID Mismatch: The Host ID you entered does not match the Email ID you entered. Please check your Host ID again.`;
        return;
      }
      
      // All verifications passed - store employee name for later use
      employeeName = employeeData.name;
      employeeGroup = employeeData.group;
      
      console.log("Verification passed! Employee:", employeeName);
      
      verificationMessage.style.display = 'none';
      const employeeForm = document.getElementById('employeeForm');
      const quizWrapper = document.getElementById('quizWrapper');
      
      if (employeeForm) {
        employeeForm.style.display = 'none';
      }
      
      if (quizWrapper) {
        quizWrapper.style.display = 'flex';
      }
      
      // Show mandatory awareness video first
      showMandatoryAwarenessVideo();
    }

    function showQuizGuidelines() {
      const splitScreenWrapper = document.querySelector('.split-screen-wrapper');
      if (splitScreenWrapper) {
        splitScreenWrapper.style.display = 'none';
      }
      
      const guidelinesHTML = `
        <div class="quiz-container" style="max-width: 900px; margin: 1rem auto; animation: fadeIn 1s ease;">
          <h1>Quiz Guidelines & Rules</h1>
          
          <!-- Welcome Card -->
          <div class="guidelines-card" style="border-left-color: #4caf50; background: linear-gradient(135deg, rgba(76, 175, 80, 0.03) 0%, rgba(76, 175, 80, 0.02) 100%);">
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
              <i class="fas fa-check-circle" style="color: #4caf50; font-size: 1.5rem;"></i>
              <div style="font-weight: 800; font-size: 1rem; color: #2e7d32; text-transform: uppercase; letter-spacing: 0.5px;">Welcome, ${employeeName}!</div>
            </div>
            <div style="color: #388e3c; font-size: 0.95rem; line-height: 1.6; font-family: 'Inter', sans-serif;">
            You have been logged in successfully. Before you start the quiz, read the guidelines and rules below carefully.
            </div>
          </div>

          <!-- Important Card -->
          <div class="guidelines-card" style="border-left-color: #ff9800; background: linear-gradient(135deg, rgba(255, 152, 0, 0.03) 0%, rgba(255, 152, 0, 0.02) 100%);">
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
              <i class="fas fa-exclamation-triangle" style="color: #ff9800; font-size: 1.5rem;"></i>
              <div style="font-weight: 800; font-size: 1rem; color: #856404; text-transform: uppercase; letter-spacing: 0.5px;">Important Notice</div>
            </div>
            <div style="color: #856404; font-size: 0.95rem; line-height: 1.6; font-family: 'Inter', sans-serif;">
              <strong>This is a proctored quiz.</strong> You must follow all guidelines and rules strictly. Any violations may result in <strong>automatic quiz submission and failure</strong>.
            </div>
          </div>

          <!-- Prohibitions Card -->
          <div class="guidelines-card" style="border-left-color: #f44336; background: linear-gradient(135deg, rgba(244, 67, 54, 0.03) 0%, rgba(244, 67, 54, 0.02) 100%);">
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
              <i class="fas fa-ban" style="color: #f44336; font-size: 1.5rem;"></i>
              <div style="font-weight: 800; font-size: 1rem; color: #f44336; text-transform: uppercase; letter-spacing: 0.5px;">Prohibited Actions</div>
            </div>
            <ul style="color: #f44336; margin: 0; padding-left: 0; list-style: none; line-height: 1.8; font-size: 0.95rem; font-family: 'Inter', sans-serif;">
              <li style="margin-bottom: 0.6rem;"><i class="fas fa-arrow-right" style="color: #f44336; margin-right: 0.6rem; font-size: 0.85rem;"></i><strong>Copy or paste</strong> any content</li>
              <li style="margin-bottom: 0.6rem;"><i class="fas fa-arrow-right" style="color: #f44336; margin-right: 0.6rem; font-size: 0.85rem;"></i><strong>Use developer tools</strong> (F12, Ctrl+Shift+I)</li>
              <li style="margin-bottom: 0.6rem;"><i class="fas fa-arrow-right" style="color: #f44336; margin-right: 0.6rem; font-size: 0.85rem;"></i><strong>Right-click</strong> to inspect elements</li>
              <li style="margin-bottom: 0.6rem;"><i class="fas fa-arrow-right" style="color: #f44336; margin-right: 0.6rem; font-size: 0.85rem;"></i><strong>Switch tabs or windows</strong> during quiz</li>
              <li style="margin-bottom: 0;"><i class="fas fa-arrow-right" style="color: #f44336; margin-right: 0.6rem; font-size: 0.85rem;"></i><strong>Exit fullscreen mode</strong> under any circumstances</li>
            </ul>
          </div>

          <!-- Monitoring Card -->
          <div class="guidelines-card" style="border-left-color: #2196f3; background: linear-gradient(135deg, rgba(33, 150, 243, 0.03) 0%, rgba(33, 150, 243, 0.02) 100%);">
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
              <i class="fas fa-shield-alt" style="color: #2196f3; font-size: 1.5rem;"></i>
              <div style="font-weight: 800; font-size: 1rem; color: #1565c0; text-transform: uppercase; letter-spacing: 0.5px;">Proctored Monitoring</div>
            </div>
            <div style="color: #1565c0; font-size: 0.95rem; line-height: 1.6; font-family: 'Inter', sans-serif; margin-bottom: 1rem;">
              <strong>This quiz is actively monitored</strong> for proctoring violations. The system will track and enforce compliance:
            </div>
            <ul style="color: #1565c0; margin: 0; padding-left: 0; list-style: none; line-height: 1.8; font-size: 0.95rem; font-family: 'Inter', sans-serif;">
              <li style="margin-bottom: 0.6rem;"><i class="fas fa-arrow-right" style="color: #2196f3; margin-right: 0.6rem; font-size: 0.85rem;"></i><strong>1st Violation:</strong> Warning message displayed</li>
              <li style="margin-bottom: 0;"><i class="fas fa-arrow-right" style="color: #2196f3; margin-right: 0.6rem; font-size: 0.85rem;"></i><strong>2nd Violation:</strong> Quiz auto-submitted as violation</li>
            </ul>
          </div>

          <!-- How to Start Card -->
          <div class="guidelines-card" style="border-left-color: #2e7d32; background: linear-gradient(135deg, rgba(46, 125, 50, 0.03) 0%, rgba(46, 125, 50, 0.02) 100%);">
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
              <i class="fas fa-play-circle" style="color: #2e7d32; font-size: 1.5rem;"></i>
              <div style="font-weight: 800; font-size: 1rem; color: #2e7d32; text-transform: uppercase; letter-spacing: 0.5px;">How to Start</div>
            </div>
            <ul style="color: #2e7d32; margin: 0; padding-left: 0; list-style: none; line-height: 1.8; font-size: 0.95rem; font-family: 'Inter', sans-serif;">
              <li style="margin-bottom: 0.6rem;"><i class="fas fa-check" style="color: #2e7d32; margin-right: 0.6rem; font-size: 0.85rem;"></i><strong>Double-click anywhere</strong> on the screen to enter fullscreen</li>
              <li style="margin-bottom: 0.6rem;"><i class="fas fa-check" style="color: #2e7d32; margin-right: 0.6rem; font-size: 0.85rem;"></i>Quiz will begin in <strong>fullscreen mode</strong> - this is mandatory</li>
              <li style="margin-bottom: 0;"><i class="fas fa-check" style="color: #2e7d32; margin-right: 0.6rem; font-size: 0.85rem;"></i>Fullscreen <strong>cannot be exited</strong> until you submit the quiz</li>
            </ul>
          </div>

          <!-- Action Buttons -->
          <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 2rem;">
            <button onclick="goBackToVideo()" style="flex: 1; min-width: 150px; padding: 0.9rem 1.5rem; background: transparent; color: #2e7d32; border: 2px solid #2e7d32; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 0.95rem; transition: all 0.3s ease; font-family: 'Inter', sans-serif;">
              ‚Üê Back to Video
            </button>
            <button onclick="acceptGuidelinesAndStart()" style="flex: 1; min-width: 150px; padding: 0.9rem 1.5rem; background: #2e7d32; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 0.95rem; transition: all 0.3s ease; font-family: 'Inter', sans-serif; box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);">
              I Understand & Agree ‚Üí
            </button>
          </div>
        </div>
      `;
      
      // Replace quizWrapper with guidelines
      document.getElementById('quizWrapper').style.display = 'none';
      const container = document.createElement('div');
      container.id = 'guidelinesContainer';
      container.innerHTML = guidelinesHTML;
      document.body.insertBefore(container, document.querySelector('.split-screen-wrapper'));
      
      // Add double-click listener for fullscreen
      document.addEventListener('dblclick', handleDoubleClickFullscreen);
    }

    function handleDoubleClickFullscreen(e) {
      // Only trigger if not on a button or input
      if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') {
        // If violation recovery is in progress, restore question and re-enter fullscreen
        if (violationCount > 0 && !isInFullscreen) {
          // Re-enable all question navigator buttons
          const navigatorGrid = document.getElementById('navigatorGrid');
          if (navigatorGrid) {
            const buttons = navigatorGrid.querySelectorAll('.question-btn');
            buttons.forEach(btn => {
              btn.style.pointerEvents = 'auto';
              btn.style.opacity = '1';
              btn.style.cursor = 'pointer';
              btn.disabled = false;
            });
          }
          
          requestFullscreen();
        }
      }
    }

    function showMandatoryAwarenessVideo() {
      const splitScreenWrapper = document.querySelector('.split-screen-wrapper');
      if (splitScreenWrapper) {
        splitScreenWrapper.style.display = 'none';
      }
      
      const videoHTML = `
        <div class="quiz-container" style="max-width: 900px; margin: 1rem auto; animation: fadeIn 1s ease;">
          <h1 style="text-align: center; margin-bottom: 1.5rem;">Mandatory Awareness Video</h1>
          
          <!-- Video Info Card -->
          <div class="guidelines-card" style="border-left-color: #2e7d32; background: linear-gradient(135deg, rgba(46, 125, 50, 0.03) 0%, rgba(46, 125, 50, 0.02) 100%); margin-bottom: 2rem;">
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
              <i class="fas fa-video" style="color: #2e7d32; font-size: 1.5rem;"></i>
              <div style="font-weight: 800; font-size: 1rem; color: #2e7d32; text-transform: uppercase; letter-spacing: 0.5px;">Important</div>
            </div>
            <div style="color: #2e7d32; font-size: 0.95rem; line-height: 1.6; font-family: 'Inter', sans-serif;">
              Before proceeding to the quiz, you <strong>must watch the complete Phishing Awareness Video</strong> to understand the threats and best practices. This is a mandatory requirement to start the assessment.
            </div>
          </div>
          
          <!-- Video Container -->
          <div style="background: #f5f7fa; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);">
            <div class="video-embed" style="position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px;">
              <iframe id="awarenessVideoIframe" width="560" height="315" src="https://www.youtube.com/embed/Y7zNlEMDmI4?si=xgLvPLtPPL9obO5K" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; border-radius: 8px;" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen loading="lazy"></iframe>
            </div>
          </div>
          
          <!-- Progress Indicator -->
          <div style="background: #fff3cd; border-left: 4px solid #ff9800; padding: 1rem; border-radius: 6px; margin-bottom: 2rem;">
            <div style="color: #856404; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
              <i class="fas fa-clock"></i>
              <span id="videoWatchStatus">Watching video... Please wait</span>
            </div>
            <div style="width: 100%; height: 6px; background: rgba(255, 152, 0, 0.2); border-radius: 3px; overflow: hidden;">
              <div id="videoProgressBar" style="height: 100%; background: linear-gradient(90deg, #ff9800, #ffc107); width: 0%; transition: width 0.5s ease; border-radius: 3px;"></div>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <button onclick="goBackToLogin()" style="flex: 1; min-width: 150px; padding: 0.9rem 1.5rem; background: transparent; color: #2e7d32; border: 2px solid #2e7d32; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 0.95rem; transition: all 0.3s ease; font-family: 'Inter', sans-serif;">
              ‚Üê Back to Login
            </button>
            <button id="proceedAfterVideoBtn" onclick="acceptVideoAndShowGuidelines()" style="flex: 1; min-width: 150px; padding: 0.9rem 1.5rem; background: #2e7d32; color: #fff; border: none; border-radius: 6px; font-weight: 700; font-size: 0.95rem; transition: all 0.3s ease; font-family: 'Inter', sans-serif; box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3); opacity: 0.6; cursor: not-allowed;">
              <i class="fas fa-play-circle"></i> Proceed to Guidelines
            </button>
          </div>
        </div>
      `;
      
      // Replace quizWrapper with video page
      document.getElementById('quizWrapper').style.display = 'none';
      const container = document.createElement('div');
      container.id = 'videoContainer';
      container.innerHTML = videoHTML;
      document.body.insertBefore(container, document.querySelector('.split-screen-wrapper'));
      
      // Track video watch time
      trackVideoProgress();
    }
    
    function trackVideoProgress() {
      const proceedBtn = document.getElementById('proceedAfterVideoBtn');
      const statusText = document.getElementById('videoWatchStatus');
      const progressBar = document.getElementById('videoProgressBar');
      
      let requiredWatchTime = 60; // 60 seconds - minimum watch time before proceeding
      let elapsed = 0;
      let buttonEnabled = false;
      let timerInterval = null;
      let pollInterval = null;
      
      // If user is returning to watch video again, enable button immediately
      if (isReturningToVideo) {
        // Function to enable the button
        function enableProceedButton(reason = 'returning-to-video') {
          if (buttonEnabled) return;
          buttonEnabled = true;
          
          if (timerInterval) clearInterval(timerInterval);
          if (pollInterval) clearInterval(pollInterval);
          
          proceedBtn.removeAttribute('disabled');
          proceedBtn.disabled = false;
          proceedBtn.style.opacity = '1';
          proceedBtn.style.pointerEvents = 'auto';
          proceedBtn.style.cursor = 'pointer';
          proceedBtn.style.backgroundColor = '#2e7d32';
          
          statusText.innerHTML = '<i class="fas fa-check-circle" style="color: #4caf50;"></i> Video ready! You can proceed to the guidelines.';
          progressBar.style.width = '100%';
          
          console.log("Proceed button enabled (" + reason + ")");
        }
        
        // Enable immediately for returning users
        enableProceedButton('returning-to-video');
        return; // Exit early - no need for timer for returning users
      }
      
      // Normal flow for first-time viewers
      // Function to enable the button
      function enableProceedButton(reason = 'timer') {
        if (buttonEnabled) return;
        buttonEnabled = true;
        
        if (timerInterval) clearInterval(timerInterval);
        if (pollInterval) clearInterval(pollInterval);
        
        proceedBtn.removeAttribute('disabled');
        proceedBtn.disabled = false;
        proceedBtn.style.opacity = '1';
        proceedBtn.style.pointerEvents = 'auto';
        proceedBtn.style.cursor = 'pointer';
        proceedBtn.style.backgroundColor = '#2e7d32';
        
        statusText.innerHTML = '<i class="fas fa-check-circle" style="color: #4caf50;"></i> Video watched! You can now proceed to the guidelines.';
        progressBar.style.width = '100%';
        
        console.log("Proceed button enabled (" + reason + ")");
      }
      
      // Load YouTube API
      const tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      let scriptExists = document.querySelector('script[src="https://www.youtube.com/iframe_api"]');
      if (!scriptExists) {
        document.head.appendChild(tag);
      }
      
      // Wait for YouTube API and create player
      setTimeout(() => {
        try {
          if (window.YT && window.YT.Player) {
            const player = new YT.Player('awarenessVideoIframe', {
              events: {
                'onStateChange': function(event) {
                  // 0 = ended, 1 = playing, 2 = paused
                  if (event.data === 0) {
                    // Video ended - enable button immediately
                    enableProceedButton('video-ended');
                  }
                }
              }
            });
            
            // Also continuously poll for video completion
            pollInterval = setInterval(() => {
              try {
                if (player && player.getCurrentTime && player.getDuration) {
                  const currentTime = player.getCurrentTime();
                  const duration = player.getDuration();
                  
                  // If video is 95%+ watched, enable button
                  if (duration > 0 && currentTime >= duration * 0.95 && !buttonEnabled) {
                    enableProceedButton('video-progress-95%');
                  }
                  
                  // Update progress bar based on video play time
                  const videoProgress = (currentTime / duration) * 100;
                  progressBar.style.width = Math.min(videoProgress, 100) + '%';
                }
              } catch (err) {
                // Silent - API might not be ready yet
              }
            }, 500);
          }
        } catch (err) {
          console.log("YouTube API integration skipped, using timer fallback");
        }
      }, 1500);
      
      // Fallback: Simple countdown timer (minimum time requirement)
      timerInterval = setInterval(() => {
        elapsed++;
        
        // Update progress bar (0-100%)
        const progress = Math.min((elapsed / requiredWatchTime) * 100, 100);
        progressBar.style.width = progress + '%';
        
        // Update status text with countdown
        const remaining = Math.max(requiredWatchTime - elapsed, 0);
        if (remaining > 0 && !buttonEnabled) {
          statusText.innerHTML = `<i class="fas fa-play" style="color: #ff9800;"></i> Watching video... (${remaining}s remaining)`;
        }
        
        // Enable button after required time
        if (elapsed >= requiredWatchTime && !buttonEnabled) {
          clearInterval(timerInterval);
          enableProceedButton('timer-elapsed');
        }
      }, 1000); // Update every second
    }
    
    function acceptVideoAndShowGuidelines() {
      const videoContainer = document.getElementById('videoContainer');
      if (videoContainer) {
        videoContainer.remove();
      }
      
      // Show quiz guidelines next
      showQuizGuidelines();
    }

    function acceptGuidelinesAndStart() {
      const guidelinesContainer = document.getElementById('guidelinesContainer');
      if (guidelinesContainer) {
        guidelinesContainer.remove();
      }
      
      document.getElementById('quizWrapper').style.display = 'flex';
      
      // Hide home icon once actual quiz starts
      const homeIcon = document.getElementById('homeIcon');
      if (homeIcon) {
        homeIcon.style.display = 'none';
      }

      // Show FDC logo in bottom right during active quiz
      const fdcLogoLink = document.getElementById('fdcLogoLink');
      if (fdcLogoLink) {
        fdcLogoLink.classList.remove('hidden');
        fdcLogoLink.classList.add('quiz-active');
        fdcLogoLink.onclick = (e) => {
          e.preventDefault();
          alert('Please submit the quiz before leaving.');
        };
      }
      
      // Load questions and start quiz
      loadAllQuestionsAndStart();
    }

    function goBackToLogin() {
      const videoContainer = document.getElementById('videoContainer');
      if (videoContainer) {
        videoContainer.remove();
      }
      
      const guidelinesContainer = document.getElementById('guidelinesContainer');
      if (guidelinesContainer) {
        guidelinesContainer.remove();
      }
      
      document.getElementById('quizWrapper').style.display = 'none';
      document.getElementById('employeeForm').style.display = 'block';
      
      // Re-enable home icon
      const homeIcon = document.getElementById('homeIcon');
      if (homeIcon) {
        homeIcon.classList.remove('disabled');
        homeIcon.style.pointerEvents = 'auto';
        homeIcon.onclick = null;
      }
      
      // Reset form
      document.getElementById('empForm').reset();
    }

    function goBackToVideo() {
      const guidelinesContainer = document.getElementById('guidelinesContainer');
      if (guidelinesContainer) {
        guidelinesContainer.remove();
      }
      
      // Set flag to indicate user is returning to video
      isReturningToVideo = true;
      
      // Show the video page again
      showMandatoryAwarenessVideo();
    }

    function goBackToHome() {
      // Remove quiz-active class from FDC logo
      const fdcLogoLink = document.getElementById('fdcLogoLink');
      if (fdcLogoLink) {
        fdcLogoLink.classList.remove('quiz-active');
      }
      // Redirect to home/index page
      window.location.href = '/';
    }

    async function loadAllQuestionsAndStart() {
      console.log("üöÄ Loading all questions and starting quiz...");
      console.log("üìä Questions before sync:", questions.length);
      
      // Initialize questions from Firebase or localStorage
      await initializeAllQuestions();
      
      console.log("üìä Questions after sync:", questions.length);
      buildNavigator();
      
      // Add double-click listener for violation recovery
      document.addEventListener('dblclick', handleDoubleClickFullscreen);
      
      // Directly enter fullscreen to start quiz
      requestFullscreen();
    }

    function showFullscreenRequiredError() {
      const quizWrapper = document.getElementById('quizWrapper');
      if (quizWrapper) {
        quizWrapper.innerHTML = `
          <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; width: 100%; background: linear-gradient(135deg, #ffebee 0%, #fff3e0 100%); padding: 2rem;">
            <!-- Error Container -->
            <div style="background: #fff; border-left: 6px solid #d32f2f; border-radius: 12px; padding: 2.5rem; max-width: 600px; width: 100%; box-shadow: 0 8px 32px rgba(211, 47, 47, 0.2);">
              
              <!-- Header with Icon -->
              <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1.5rem;">
                <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #d32f2f;"></i>
                <div style="font-size: 2rem; font-weight: 800; color: #d32f2f; letter-spacing: 0.05em;">ERROR</div>
              </div>

              <!-- Sub-heading -->
              <div style="text-align: center; font-size: 1.5rem; font-weight: 700; color: #c62828; margin-bottom: 1.5rem; font-family: 'Inter', sans-serif;">
                Fullscreen Mode Required
              </div>

              <!-- Error Message -->
              <div style="text-align: center; color: #424242; font-size: 1rem; line-height: 1.8; margin-bottom: 2rem; font-family: 'Inter', sans-serif;">
                <div style="background: #ffebee; border-left: 4px solid #d32f2f; padding: 1.5rem; border-radius: 6px; margin-bottom: 1.5rem;">
                  <strong style="color: #c62828; font-size: 1.1rem;">The quiz cannot continue in windowed mode.</strong>
                  <br><br>
                  <span style="color: #666;">Fullscreen mode is mandatory for this quiz to ensure test integrity and proctoring compliance. This quiz is designed to work only in fullscreen mode.</span>
                </div>
                <div style="color: #666; font-size: 0.95rem; background: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 6px; padding: 1rem;">
                  <strong>Possible reasons:</strong>
                  <ul style="text-align: left; display: inline-block; margin: 0.5rem 0;">
                    <li>Fullscreen mode is disabled in your browser settings</li>
                    <li>Browser doesn't support fullscreen API</li>
                    <li>Fullscreen permission was denied</li>
                  </ul>
                </div>
              </div>

              <!-- Instructions -->
              <div style="background: #e3f2fd; border: 2px solid #1976d2; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; text-align: center; box-shadow: 0 4px 12px rgba(25, 118, 210, 0.1);">
                <div style="font-weight: 700; color: #1565c0; font-size: 1.1rem; margin-bottom: 1rem; font-family: 'Inter', sans-serif;">What to do:</div>
                <div style="color: #1565c0; font-size: 0.95rem; line-height: 1.8; font-family: 'Inter', sans-serif;">
                  <strong>1.</strong> Check your browser settings and enable fullscreen mode<br>
                  <strong>2.</strong> Allow fullscreen permission when prompted<br>
                  <strong>3.</strong> Reload this page and try again<br>
                  <strong>4.</strong> If the issue persists, try a different browser
                </div>
              </div>

              <!-- Compliance Notice -->
              <div style="background: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 6px; padding: 1rem; text-align: center; font-size: 0.85rem; color: #666; font-family: 'Inter', sans-serif; line-height: 1.6;">
                <i class="fas fa-shield-alt" style="color: #d32f2f; margin-right: 0.5rem;"></i>
                <strong style="color: #d32f2f;">Security Requirement:</strong> Fullscreen mode is required to prevent cheating and ensure fair assessment for all participants.
              </div>
            </div>
          </div>
        `;
      }
    }

    function requestFullscreen() {
      const elem = document.documentElement;
      
      if (elem.requestFullscreen) {
        elem.requestFullscreen().then(() => {
          isInFullscreen = true;
          displayQuestion();
          enableProctoring();
        }).catch(err => {
          console.warn('Fullscreen request failed:', err);
          showFullscreenRequiredError();
        });
      } else if (elem.webkitRequestFullscreen) {
        // Safari
        try {
          elem.webkitRequestFullscreen();
          isInFullscreen = true;
          displayQuestion();
          if (violationCount === 0) {
            enableProctoring();
          }
        } catch (err) {
          console.warn('Fullscreen request failed:', err);
          showFullscreenRequiredError();
        }
      } else if (elem.mozRequestFullScreen) {
        // Firefox
        try {
          elem.mozRequestFullScreen();
          isInFullscreen = true;
          displayQuestion();
          if (violationCount === 0) {
            enableProctoring();
          }
        } catch (err) {
          console.warn('Fullscreen request failed:', err);
          showFullscreenRequiredError();
        }
      } else if (elem.msRequestFullscreen) {
        // IE/Edge
        try {
          elem.msRequestFullscreen();
          isInFullscreen = true;
          displayQuestion();
          if (violationCount === 0) {
            enableProctoring();
          }
        } catch (err) {
          console.warn('Fullscreen request failed:', err);
          showFullscreenRequiredError();
        }
      } else {
        // Fullscreen API not supported
        console.error('Fullscreen API not supported in this browser');
        showFullscreenRequiredError();
      }
      
      // Prevent exiting fullscreen
      document.addEventListener('fullscreenchange', handleFullscreenChange);
      document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
      document.addEventListener('mozfullscreenchange', handleFullscreenChange);
      document.addEventListener('msfullscreenchange', handleFullscreenChange);
    }

    function handleFullscreenChange() {
      if (!document.fullscreenElement && !document.webkitFullscreenElement && 
          !document.mozFullScreenElement && !document.msFullscreenElement) {
        // User exited fullscreen
        if (!isQuizSubmitted && isInFullscreen && !isInRecoveryMode) {
          isInFullscreen = false;
          violationCount++;
          
          if (violationCount === 1) {
            // First violation - show warning and ask to double-click
            isInRecoveryMode = true;
            showViolationRecoveryPrompt();
          } else if (violationCount >= 2) {
            // Second violation - auto-submit
            handleViolationAutoSubmit('FULLSCREEN_EXIT');
          }
        }
      } else {
        // Fullscreen entered
        isInFullscreen = true;
        isInRecoveryMode = false;
        
        // If resuming after violation, display the question
        if (resumingAfterViolation) {
          resumingAfterViolation = false;
          displayQuestion();
        }
      }
    }

    function showViolationRecoveryPrompt() {
      // Disable all question navigator buttons
      const navigatorGrid = document.getElementById('navigatorGrid');
      if (navigatorGrid) {
        const buttons = navigatorGrid.querySelectorAll('.question-btn');
        buttons.forEach(btn => {
          btn.style.pointerEvents = 'none';
          btn.style.opacity = '0.5';
          btn.style.cursor = 'not-allowed';
          btn.disabled = true;
        });
      }

      // Disable all control buttons (Previous, Clear, Next, Submit Quiz, Exit Quiz)
      if (prevBtn) {
        prevBtn.disabled = true;
        prevBtn.style.pointerEvents = 'none';
        prevBtn.style.opacity = '0.5';
        prevBtn.style.cursor = 'not-allowed';
      }
      if (clearBtn) {
        clearBtn.disabled = true;
        clearBtn.style.pointerEvents = 'none';
        clearBtn.style.opacity = '0.5';
        clearBtn.style.cursor = 'not-allowed';
      }
      if (nextBtn) {
        nextBtn.disabled = true;
        nextBtn.style.pointerEvents = 'none';
        nextBtn.style.opacity = '0.5';
        nextBtn.style.cursor = 'not-allowed';
      }
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.style.pointerEvents = 'none';
        submitBtn.style.opacity = '0.5';
        submitBtn.style.cursor = 'not-allowed';
      }
      
      // Disable submit and exit buttons in navigator
      const submitNavBtn = document.getElementById('submitNavBtn');
      const exitBtn = document.querySelector('.btn-exit');
      if (submitNavBtn) {
        submitNavBtn.disabled = true;
        submitNavBtn.style.pointerEvents = 'none';
        submitNavBtn.style.opacity = '0.5';
        submitNavBtn.style.cursor = 'not-allowed';
      }
      if (exitBtn) {
        exitBtn.disabled = true;
        exitBtn.style.pointerEvents = 'none';
        exitBtn.style.opacity = '0.5';
        exitBtn.style.cursor = 'not-allowed';
      }

      // Hide the question content
      const questionContent = document.getElementById('questionContent');
      if (questionContent) {
        questionContent.innerHTML = `
          <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%; background: linear-gradient(135deg, #ffebee 0%, #fff3e0 100%); padding: 2rem;">
            <!-- Main Warning Container -->
            <div style="background: #fff; border-left: 6px solid #f44336; border-radius: 12px; padding: 2.5rem; max-width: 500px; width: 100%; box-shadow: 0 8px 32px rgba(244, 67, 54, 0.15); animation: slideInDown 0.6s ease-out;">
              
              <!-- Header with Icon -->
              <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1.5rem;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; color: #f44336; animation: pulse 1.5s ease-in-out infinite;"></i>
                <div style="font-size: 1.8rem; font-weight: 800; color: #f44336; letter-spacing: 0.05em;">WARNING</div>
              </div>

              <!-- Sub-heading -->
              <div style="text-align: center; font-size: 1.4rem; font-weight: 700; color: #d32f2f; margin-bottom: 1.5rem; font-family: 'Inter', sans-serif;">
                You Exited Fullscreen!
              </div>

              <!-- Warning Message -->
              <div style="text-align: center; color: #424242; font-size: 1rem; line-height: 1.8; margin-bottom: 2rem; font-family: 'Inter', sans-serif;">
                <div style="background: #ffebee; border-left: 4px solid #f44336; padding: 1.2rem; border-radius: 6px; margin-bottom: 1.5rem;">
                  <strong style="color: #c62828; font-size: 1.05rem;">This is your first and final warning.</strong>
                  <br>
                  <strong style="color: #d32f2f;">Exiting fullscreen again will result in automatic quiz submission and failure.</strong>
                </div>
                <div style="color: #666; font-size: 0.95rem;">
                  Maintain fullscreen mode to ensure quiz integrity and proctoring compliance.
                </div>
              </div>

              <!-- Action Card -->
              <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px; padding: 1.8rem; margin-bottom: 1.5rem; text-align: center; box-shadow: 0 4px 12px rgba(33, 150, 243, 0.1);">
                <div style="display: flex; justify-content: center; align-items: center; gap: 0.8rem; margin-bottom: 0.8rem;">
                  <i class="fas fa-mouse-pointer" style="font-size: 1.5rem; color: #1565c0;"></i>
                  <div style="font-weight: 700; color: #1565c0; font-size: 1.15rem; font-family: 'Inter', sans-serif;">ACTION REQUIRED</div>
                </div>
                <div style="color: #1565c0; font-weight: 600; font-size: 1rem; margin-bottom: 0.5rem; font-family: 'Inter', sans-serif;">
                  DOUBLE-CLICK anywhere to Re-Enter Fullscreen
                </div>
                <div style="color: #0d47a1; font-size: 0.9rem; font-family: 'Inter', sans-serif;">
                  Double-click on this screen to continue the quiz in fullscreen mode.
                </div>
              </div>

              <!-- Compliance Notice -->
              <div style="background: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 6px; padding: 1rem; text-align: center; font-size: 0.85rem; color: #666; font-family: 'Inter', sans-serif; line-height: 1.6;">
                <i class="fas fa-shield-alt" style="color: #2e7d32; margin-right: 0.5rem;"></i>
                <strong style="color: #2e7d32;">Security Notice:</strong> Your quiz is being monitored. All violations are recorded.
              </div>
            </div>
          </div>
          <style>
            @keyframes slideInDown {
              from {
                opacity: 0;
                transform: translateY(-30px);
              }
              to {
                opacity: 1;
                transform: translateY(0);
              }
            }
            @keyframes pulse {
              0%, 100% {
                opacity: 1;
                transform: scale(1);
              }
              50% {
                opacity: 0.7;
                transform: scale(1.1);
              }
            }
          </style>
        `;

        // Add double-click handler to resume quiz
        questionContent.addEventListener('dblclick', handleDoubleClickToResume, { once: false });
      }
    }

    function handleDoubleClickToResume(event) {
      console.log('üîÑ Double-click detected - attempting to resume quiz');
      
      // Stop event propagation
      if (event) {
        event.stopPropagation();
        event.preventDefault();
      }
      
      // Remove the double-click listener from the question content
      const questionContent = document.getElementById('questionContent');
      if (questionContent) {
        questionContent.removeEventListener('dblclick', handleDoubleClickToResume);
        // Clear the warning message IMMEDIATELY and completely
        questionContent.innerHTML = '';
        questionContent.style.display = 'block';
        questionContent.style.visibility = 'visible';
      }

      // Exit recovery mode
      isInRecoveryMode = false;
      resumingAfterViolation = true;
      
      // Re-enable all control buttons
      if (prevBtn) {
        prevBtn.disabled = false;
        prevBtn.style.pointerEvents = 'auto';
        prevBtn.style.opacity = '1';
        prevBtn.style.cursor = 'pointer';
      }
      if (clearBtn) {
        clearBtn.disabled = false;
        clearBtn.style.pointerEvents = 'auto';
        clearBtn.style.opacity = '1';
        clearBtn.style.cursor = 'pointer';
      }
      if (nextBtn) {
        nextBtn.disabled = false;
        nextBtn.style.pointerEvents = 'auto';
        nextBtn.style.opacity = '1';
        nextBtn.style.cursor = 'pointer';
      }
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.style.pointerEvents = 'auto';
        submitBtn.style.opacity = '1';
        submitBtn.style.cursor = 'pointer';
      }

      // Re-enable submit and exit buttons in navigator
      const submitNavBtn = document.getElementById('submitNavBtn');
      const exitBtn = document.querySelector('.btn-exit');
      if (submitNavBtn) {
        submitNavBtn.disabled = false;
        submitNavBtn.style.pointerEvents = 'auto';
        submitNavBtn.style.opacity = '1';
        submitNavBtn.style.cursor = 'pointer';
      }
      if (exitBtn) {
        exitBtn.disabled = false;
        exitBtn.style.pointerEvents = 'auto';
        exitBtn.style.opacity = '1';
        exitBtn.style.cursor = 'pointer';
      }

      // Re-enable navigator grid buttons
      const navigatorGrid = document.getElementById('navigatorGrid');
      if (navigatorGrid) {
        const buttons = navigatorGrid.querySelectorAll('.question-btn');
        buttons.forEach(btn => {
          btn.style.pointerEvents = 'auto';
          btn.style.opacity = '1';
          btn.style.cursor = 'pointer';
          btn.disabled = false;
        });
      }

      // Function to safely display question
      const safeDisplayQuestion = () => {
        console.log('üìù Calling displayQuestion()...');
        try {
          // Ensure content is clear first
          const qc = document.getElementById('questionContent');
          if (qc) {
            qc.innerHTML = '';
          }
          
          // Now display the question
          displayQuestion();
          console.log('‚úÖ displayQuestion() completed successfully');
          resumingAfterViolation = false;
        } catch (err) {
          console.error('‚ùå Error in displayQuestion():', err);
          resumingAfterViolation = false;
        }
      };

      // Use immediate synchronous call first with short timeout
      safeDisplayQuestion();
      
      // Request fullscreen with additional fallback
      const elem = document.documentElement;
      
      if (elem.requestFullscreen) {
        elem.requestFullscreen().then(() => {
          console.log('‚úÖ Fullscreen entered successfully');
          isInFullscreen = true;
          safeDisplayQuestion();
        }).catch(err => {
          console.log("Fullscreen request failed during resume:", err);
          isInFullscreen = true;
        });
      } else if (elem.webkitRequestFullscreen) {
        try {
          elem.webkitRequestFullscreen();
          isInFullscreen = true;
          console.log('‚úÖ Fullscreen entered (webkit)');
          setTimeout(safeDisplayQuestion, 100);
        } catch (err) {
          console.log("Fullscreen request failed during resume:", err);
          isInFullscreen = true;
        }
      } else if (elem.mozRequestFullScreen) {
        try {
          elem.mozRequestFullScreen();
          isInFullscreen = true;
          console.log('‚úÖ Fullscreen entered (mozilla)');
          setTimeout(safeDisplayQuestion, 100);
        } catch (err) {
          console.log("Fullscreen request failed during resume:", err);
          isInFullscreen = true;
        }
      } else if (elem.msRequestFullscreen) {
        try {
          elem.msRequestFullscreen();
          isInFullscreen = true;
          console.log('‚úÖ Fullscreen entered (ms)');
          setTimeout(safeDisplayQuestion, 100);
        } catch (err) {
          console.log("Fullscreen request failed during resume:", err);
          isInFullscreen = true;
        }
      } else {
        console.log('‚ùå Fullscreen API not supported');
        isInFullscreen = true;
      }
    }

    function handleViolationAutoSubmit(violationType) {
      isQuizSubmitted = true;
      violationCount = 0;
      
      let violationMessage = '';
      if (violationType === 'FULLSCREEN_EXIT') {
        violationMessage = 'Exiting fullscreen mode multiple times';
      } else if (violationType === 'TAB_SWITCH') {
        violationMessage = 'Switching tabs or windows multiple times';
      }
      
      // Show violation message
      alert(`üö´ VIOLATION DETECTED!\n\n${violationMessage}\n\nYour quiz has been automatically submitted due to proctoring rule violations. This submission will be marked as a violation.`);
      
      // Auto-submit the quiz
      submitQuizWithViolation();
    }

    async function submitQuizWithViolation() {
      saveCurrentAnswer();
      
      let score = 0;
      userAnswers.forEach((answer, index) => {
        const correctAnswer = questions[index].answer;
        let isCorrect = false;
        
        if (Array.isArray(correctAnswer)) {
          if (Array.isArray(answer)) {
            isCorrect = answer.length === correctAnswer.length && 
                       answer.every(a => correctAnswer.includes(a)) &&
                       correctAnswer.every(c => answer.includes(c));
          } else if (answer !== null) {
            isCorrect = correctAnswer.includes(answer);
          }
        } else {
          if (Array.isArray(answer)) {
            isCorrect = answer.includes(correctAnswer);
          } else {
            isCorrect = answer === correctAnswer;
          }
        }
        
        if (isCorrect) {
          score++;
        }
      });

      const attempt = {
        employeeName: employeeName,
        employeeGroup: employeeGroup,
        employeeId: employeeId,
        timestamp: new Date().toISOString(),
        score: score,
        totalQuestions: questions.length,
        userAnswers: userAnswers,
        questions: questions,
        violationFlag: true,
        violationType: 'PROCTORING_VIOLATION'
      };

      // Save to Firebase
      if (window.saveQuizAttemptToFirebase) {
        try {
          const firebaseAttempt = {
            employeeName: employeeName,
            employeeGroup: employeeGroup,
            employeeId: employeeId,
            timestamp: new Date().toISOString(),
            score: score,
            totalQuestions: questions.length,
            userAnswersJSON: JSON.stringify(userAnswers),
            violationFlag: true,
            violationType: 'PROCTORING_VIOLATION'
          };
          await window.saveQuizAttemptToFirebase(firebaseAttempt);
        } catch (err) {
          console.error("Firebase save error:", err);
        }
      }

      // Also save to localStorage
      let attempts = JSON.parse(localStorage.getItem('quizAttempts') || '[]');
      attempts.push(attempt);
      localStorage.setItem('quizAttempts', JSON.stringify(attempts));

      showViolationSummary(score);
    }

    function showViolationSummary(score) {
      const percentage = Math.round((score / questions.length) * 100);

      const html = `
        <div style="position: relative;">
          <!-- Home Icon Button (Top Left) -->
          <a href="/" onclick="goBackToHome()" style="position: absolute; top: 1.5rem; left: 1.5rem; width: 3rem; height: 3rem; background: #2e7d32; color: #fff; border: 2px solid #2e7d32; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; cursor: pointer; text-decoration: none; box-shadow: 0 2px 8px rgba(46, 125, 50, 0.2); transition: all 0.3s ease; z-index: 100;" onmouseover="this.style.background='#fff'; this.style.color='#2e7d32'; this.style.boxShadow='0 4px 12px rgba(46, 125, 50, 0.3)'" onmouseout="this.style.background='#2e7d32'; this.style.color='#fff'; this.style.boxShadow='0 2px 8px rgba(46, 125, 50, 0.2)'">
            <i class="fas fa-home"></i>
          </a>
          
          <div class="performance-summary">
            <div class="employee-info">
              <strong>${employeeName}</strong> | Group: ${employeeGroup} | ID: ${employeeId}
            </div>
            <div style="font-size: 1.8rem; color: #f44336; font-weight: 700; margin-bottom: 1.5rem;">‚ö†Ô∏è VIOLATION - QUIZ TERMINATED</div>
            <div style="background: #ffebee; border-left: 4px solid #f44336; padding: 1.5rem; border-radius: 6px; margin-bottom: 2rem;">
              <div style="color: #f44336; font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem;">Proctoring Violation Detected</div>
              <div style="color: #f44336; font-size: 0.95rem; line-height: 1.6;">
                Your quiz was automatically submitted due to multiple proctoring rule violations. This submission has been flagged and will be reviewed by the administrator.
              </div>
            </div>
          <div class="summary-stats">
            <div class="stat-box">
              <div class="stat-label">Score</div>
              <div class="stat-value">${score}/${questions.length}</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Percentage</div>
              <div class="stat-value">${percentage}%</div>
            </div>
          </div>
          <div style="background: #fff3cd; border-left: 4px solid #ff9800; padding: 1.5rem; margin-top: 1.5rem; border-radius: 6px;">
            <div style="color: #856404; font-weight: 700; margin-bottom: 0.5rem;">‚ö†Ô∏è Note</div>
            <div style="color: #856404; font-size: 0.95rem; line-height: 1.6;">
              This quiz submission has been flagged for proctoring violations. The administrator will review this attempt and take appropriate action.
            </div>
          </div>
          
          <!-- Back to Home Button (Bottom Center) -->
          <div style="display: flex; justify-content: center; margin-top: 2.5rem; padding-bottom: 1.5rem;">
            <button onclick="goBackToHome()" style="padding: 0.9rem 2.5rem; background: linear-gradient(135deg, #2e7d32, #4caf50); color: #fff; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3); font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(46, 125, 50, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(46, 125, 50, 0.3)'">
              ‚Üê Back to Home
            </button>
          </div>
          </div>
        </div>
      `;

      const mainStage = document.getElementById('mainStage');
      if (mainStage) {
        mainStage.style.flex = '1 1 100%';
        mainStage.innerHTML = html;
        // Add copyright footer to violation results page
        appendCopyrightFooter(mainStage);
      }

      // Hide navigator
      const navigator = document.getElementById('navigator');
      if (navigator) {
        navigator.style.display = 'none';
      }
      
      // Re-enable home icon after violation submission
      const homeIcon = document.getElementById('homeIcon');
      if (homeIcon) {
        homeIcon.classList.remove('disabled');
        homeIcon.style.pointerEvents = 'auto';
        homeIcon.onclick = null;
      }
    }

    function enableProctoring() {
      // Disable copy-paste
      document.addEventListener('copy', (e) => {
        e.preventDefault();
        alert('‚ö†Ô∏è Copy is disabled during the quiz. Please focus on answering the questions.');
      });
      
      document.addEventListener('cut', (e) => {
        e.preventDefault();
        alert('‚ö†Ô∏è Cut is disabled during the quiz. Please focus on answering the questions.');
      });
      
      document.addEventListener('paste', (e) => {
        e.preventDefault();
        alert('‚ö†Ô∏è Paste is disabled during the quiz. Please focus on answering the questions.');
      });
      
      // Disable right-click context menu
      document.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        alert('‚ö†Ô∏è Right-click is disabled during the quiz.');
        return false;
      });
      
      // Detect tab/window switching
      document.addEventListener('visibilitychange', () => {
        if (document.hidden && !isQuizSubmitted) {
          violationCount++;
          
          if (violationCount === 1) {
            // First violation - show warning
            alert('‚ö†Ô∏è WARNING! You switched away from the quiz tab. This is a violation of quiz rules.\n\nYou have 1 warning. Another violation will result in automatic quiz submission and failure.');
          } else if (violationCount >= 2) {
            // Second violation - auto-submit
            handleViolationAutoSubmit('TAB_SWITCH');
          }
        }
      });
      
      // Prevent keyboard shortcuts for dev tools and other functions
      document.addEventListener('keydown', (e) => {
        // F12 - Developer Tools
        if (e.key === 'F12') {
          e.preventDefault();
          alert('‚ö†Ô∏è Developer tools are disabled during the quiz.');
          return false;
        }
        
        // Ctrl+Shift+I - Inspector
        if (e.ctrlKey && e.shiftKey && e.key === 'I') {
          e.preventDefault();
          alert('‚ö†Ô∏è Developer tools are disabled during the quiz.');
          return false;
        }
        
        // Ctrl+Shift+J - Console
        if (e.ctrlKey && e.shiftKey && e.key === 'J') {
          e.preventDefault();
          alert('‚ö†Ô∏è Developer tools are disabled during the quiz.');
          return false;
        }
        
        // Ctrl+Shift+C - Element Inspector
        if (e.ctrlKey && e.shiftKey && e.key === 'C') {
          e.preventDefault();
          alert('‚ö†Ô∏è Developer tools are disabled during the quiz.');
          return false;
        }
        
        // Ctrl+Shift+K - Developer Console
        if (e.ctrlKey && e.shiftKey && e.key === 'K') {
          e.preventDefault();
          alert('‚ö†Ô∏è Developer tools are disabled during the quiz.');
          return false;
        }
      });
      
      // Prevent opening new windows/tabs
      window.addEventListener('beforeunload', (e) => {
        if (!isQuizSubmitted) {
          e.preventDefault();
          e.returnValue = '';
          return false;
        }
      });
      
      // Disable selection of text (optional, can be uncommented if needed)
      // document.body.style.userSelect = 'none';
      // document.body.style.webkitUserSelect = 'none';
      
      console.log('üîí Proctoring features enabled. Quiz is now in secure mode.');
    }

    function buildNavigator() {
      const navigatorGrid = document.getElementById('navigatorGrid');
      navigatorGrid.innerHTML = '';
      
      questions.forEach((_, index) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = index + 1;
        btn.className = 'question-btn unattempted';
        btn.id = `q-btn-${index}`;
        btn.onclick = () => jumpToQuestion(index);
        navigatorGrid.appendChild(btn);
      });
      
      updateNavigator();
    }

    function updateNavigator() {
      questions.forEach((_, index) => {
        const btn = document.getElementById(`q-btn-${index}`);
        btn.className = 'question-btn';
        
        if (index === currentQuestionIndex) {
          btn.classList.add('current');
        } else if (userAnswers[index] !== null) {
          btn.classList.add('answered');
        } else {
          btn.classList.add('unattempted');
        }
      });
    }

    function jumpToQuestion(index) {
      if (isQuizSubmitted) return;
      saveCurrentAnswer();
      currentQuestionIndex = index;
      displayQuestion();
    }

    function displayQuestion() {
      // Safety check - ensure questions are loaded
      if (!questions || questions.length === 0) {
        console.error("No questions available to display!");
        document.getElementById("questionContent").innerHTML = '<div style="color: red; text-align: center; padding: 2rem;">Error: No questions available. Please refresh the page.</div>';
        return;
      }

      const question = questions[currentQuestionIndex];
      
      // Safety check for question existence
      if (!question) {
        console.error("Question at index " + currentQuestionIndex + " is undefined!");
        return;
      }

      const currentQuestionSpan = document.getElementById('currentQuestion');
      const totalQuestionsSpan = document.getElementById('totalQuestions');
      const questionContent = document.getElementById("questionContent");
      
      currentQuestionSpan.textContent = currentQuestionIndex + 1;
      totalQuestionsSpan.textContent = questions.length;
      
      // Check if this question has multiple correct answers
      const hasMultipleAnswers = Array.isArray(question.answer);
      
      let html = `
        <div class="question-text">Q${currentQuestionIndex + 1}: ${question.q}</div>
      `;
      
      html += `<div class="options">`;
      question.options.forEach((opt, j) => {
        let isSelected = false;
        let checkedAttr = '';
        let selectedClass = '';
        
        if (hasMultipleAnswers) {
          // For multiple answers, userAnswers is an array
          isSelected = Array.isArray(userAnswers[currentQuestionIndex]) && userAnswers[currentQuestionIndex].includes(j);
          checkedAttr = isSelected ? 'checked' : '';
          selectedClass = isSelected ? 'selected' : '';
          
          html += `
            <label class="${selectedClass}">
              <input type="checkbox" name="currentQuestion" value="${j}" ${checkedAttr} onchange="handleOptionSelect(${j}, ${hasMultipleAnswers})">
              ${opt}
            </label>
          `;
        } else {
          // For single answer, keep radio button behavior
          isSelected = userAnswers[currentQuestionIndex] === j;
          checkedAttr = isSelected ? 'checked' : '';
          selectedClass = isSelected ? 'selected' : '';
          
          html += `
            <label class="${selectedClass}">
              <input type="radio" name="currentQuestion" value="${j}" ${checkedAttr} onchange="handleOptionSelect(${j}, false)">
              ${opt}
            </label>
          `;
        }
      });
      html += `</div>`;
      
      questionContent.innerHTML = html;
      updateButtonStates();
      updateNavigator();
      resetTimer();
      startTimer();
    }

    function handleOptionSelect(optionIndex, isMultiple) {
      if (isMultiple) {
        // For multiple answers, manage array
        if (!Array.isArray(userAnswers[currentQuestionIndex])) {
          userAnswers[currentQuestionIndex] = [];
        }
        
        const checkbox = document.querySelector(`input[name="currentQuestion"][value="${optionIndex}"]`);
        if (checkbox.checked) {
          if (!userAnswers[currentQuestionIndex].includes(optionIndex)) {
            userAnswers[currentQuestionIndex].push(optionIndex);
          }
        } else {
          userAnswers[currentQuestionIndex] = userAnswers[currentQuestionIndex].filter(idx => idx !== optionIndex);
        }
      } else {
        // For single answer, keep original behavior
        userAnswers[currentQuestionIndex] = optionIndex;
        
        const labels = document.querySelectorAll('.options label');
        labels.forEach((label, idx) => {
          if (idx === optionIndex) {
            label.classList.add('selected');
          } else {
            label.classList.remove('selected');
          }
        });
        return; // Early return to avoid the selected class logic below
      }
      
      // Update selected class for multiple answer questions
      const labels = document.querySelectorAll('.options label');
      labels.forEach((label, idx) => {
        const isChecked = document.querySelector(`input[name="currentQuestion"][value="${idx}"]`).checked;
        if (isChecked) {
          label.classList.add('selected');
        } else {
          label.classList.remove('selected');
        }
      });
      
      updateNavigator();
    }

    function updateButtonStates() {
      prevBtn.disabled = currentQuestionIndex === 0;
      nextBtn.style.display = currentQuestionIndex === questions.length - 1 ? 'none' : 'block';
      submitBtn.style.display = currentQuestionIndex === questions.length - 1 ? 'block' : 'none';
      
      // Keep navigator submit button always visible when quiz is active (not submitted)
      const submitNavBtn = document.getElementById('submitNavBtn');
      if (submitNavBtn) {
        submitNavBtn.style.display = isQuizSubmitted ? 'none' : 'flex';
        submitNavBtn.disabled = isQuizSubmitted;
      }
    }

    function saveCurrentAnswer() {
      const question = questions[currentQuestionIndex];
      const hasMultipleAnswers = Array.isArray(question.answer);
      
      if (hasMultipleAnswers) {
        // For multiple answers, collect all checked checkboxes
        const selectedOptions = document.querySelectorAll('input[name="currentQuestion"]:checked');
        if (selectedOptions.length > 0) {
          userAnswers[currentQuestionIndex] = Array.from(selectedOptions).map(opt => parseInt(opt.value));
        } else {
          userAnswers[currentQuestionIndex] = null;
        }
      } else {
        // For single answer, keep original behavior
        const selectedOption = document.querySelector('input[name="currentQuestion"]:checked');
        if (selectedOption) {
          userAnswers[currentQuestionIndex] = parseInt(selectedOption.value);
        } else {
          userAnswers[currentQuestionIndex] = null;
        }
      }
    }

    function nextQuestion() {
      saveCurrentAnswer();
      if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        displayQuestion();
      }
    }

    function previousQuestion() {
      saveCurrentAnswer();
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        displayQuestion();
      }
    }

    function clearOption() {
      userAnswers[currentQuestionIndex] = null;
      const inputs = document.querySelectorAll('input[name="currentQuestion"]');
      inputs.forEach(input => input.checked = false);
      document.querySelectorAll('.options label').forEach(label => label.classList.remove('selected'));
      updateNavigator();
    }

    function resetTimer() {
      // Timer disabled
    }

    function startTimer() {
      // Timer disabled
    }

    async function submitQuizFromNavigator() {
      if (isQuizSubmitted) return;
      
      // Save current answer before showing review
      saveCurrentAnswer();
      
      // Store the question index from which submit was clicked
      submittedFromQuestionIndex = currentQuestionIndex;
      
      // Show the pre-submission review page
      showPreSubmissionReview();
    }

    function showPreSubmissionReview() {
      // Hide the navigator
      const navigator = document.getElementById('navigator');
      if (navigator) {
        navigator.style.display = 'none';
      }
      
      // Make mainStage full width
      const mainStage = document.getElementById('mainStage');
      if (mainStage) {
        mainStage.style.flex = '1 1 100%';
      }
      
      let html = `
        <div style="display: flex; flex-direction: column; height: 100%; overflow: hidden;">
          <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid #2e7d32; flex-shrink: 0;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="font-weight: 700; color: #2e7d32; font-size: 1.1rem;">Review Before Submitting</div>
            </div>
            <div style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">Please scroll down and review your answers before final submission. You cannot change your answers after submitting.</div>
          </div>
          <div style="flex: 1; overflow-y: auto; padding-right: 0.5rem;">
      `;

      let attemptedCount = 0;
      let notAttemptedCount = 0;

      questions.forEach((question, index) => {
        const userAnswer = userAnswers[index];
        const isUnattempted = userAnswer === null;

        if (isUnattempted) {
          notAttemptedCount++;
        } else {
          attemptedCount++;
        }

        let statusBadge = '';
        let statusColor = '';
        if (isUnattempted) {
          statusBadge = 'Not Attempted';
          statusColor = '#ff9800';
        } else {
          statusBadge = '‚úì Answered';
          statusColor = '#2196f3';
        }

        html += `
          <div style="background: #f9f9f9; border-left: 4px solid ${statusColor}; padding: 1.2rem; margin-bottom: 1rem; border-radius: 6px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
              <div style="font-weight: 700; color: #2e7d32; font-size: 1rem; flex: 1;">Q${index + 1}: ${question.q}</div>
              <div style="background: ${statusColor}; color: #fff; padding: 0.4rem 0.8rem; border-radius: 4px; font-weight: 600; font-size: 0.85rem; white-space: nowrap; margin-left: 1rem;">${statusBadge}</div>
            </div>
        `;

        if (question.image && question.image.trim()) {
          html += `<img src="${question.image}" alt="Question Image" style="width: 100%; max-height: 120px; object-fit: contain; border-radius: 4px; margin-bottom: 1rem;">`;
        }

        html += `<div style="background: #fff; border: 1px solid #e0e0e0; border-radius: 4px; padding: 1rem;">`;

        // Show all options with user's answer highlighted
        question.options.forEach((option, optIndex) => {
          let optStyle = '';
          let icon = '';

          // Check if user selected this option
          let userSelectedThis = false;
          if (Array.isArray(userAnswer)) {
            userSelectedThis = userAnswer.includes(optIndex);
          } else {
            userSelectedThis = optIndex === userAnswer;
          }

          if (userSelectedThis) {
            optStyle = 'background: #e3f2fd; border-left: 3px solid #2196f3;';
            icon = '<i class="fas fa-check-circle" style="color: #2196f3; margin-right: 0.5rem;"></i>';
          }

          let label = '';
          if (userSelectedThis) {
            label = '<span style="color: #2196f3; font-weight: 600; margin-left: auto;">(Your Answer)</span>';
          }

          html += `
            <div style="padding: 0.8rem; margin-bottom: 0.5rem; border-radius: 4px; display: flex; align-items: center; ${optStyle}">
              ${icon}
              <span>${option}</span>
              ${label}
            </div>
          `;
        });

        html += `</div>`;

        if (isUnattempted) {
          html += `
            <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 0.8rem; margin-top: 1rem; border-radius: 4px;">
              <strong style="color: #ff9800;">Not Attempted</strong> - You did not select an answer for this question.
            </div>
          `;
        } else {
          html += `
            <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 0.8rem; margin-top: 1rem; border-radius: 4px;">
              <strong style="color: #2196f3;">Answered</strong>
            </div>
          `;
        }

        html += `</div>`;
      });

      // Summary section at the top of scroll
      const summaryHtml = `
        <div style="background: #f0f7f0; border: 2px solid #2e7d32; padding: 1.2rem; margin-bottom: 1.5rem; border-radius: 6px;">
          <div style="font-weight: 700; color: #2e7d32; font-size: 1.1rem; margin-bottom: 1rem;">Summary</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div style="background: #fff; padding: 1rem; border-radius: 6px; border: 1px solid #e0e0e0;">
              <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">Answered</div>
              <div style="font-size: 1.8rem; font-weight: 700; color: #2196f3;">${attemptedCount}</div>
            </div>
            <div style="background: #fff; padding: 1rem; border-radius: 6px; border: 1px solid #e0e0e0;">
              <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">Not Attempted</div>
              <div style="font-size: 1.8rem; font-weight: 700; color: #ff9800;">${notAttemptedCount}</div>
            </div>
          </div>
        </div>
      `;

      html += `
          </div>
          <div style="flex-shrink: 0; padding-top: 1rem; border-top: 2px solid #e0e0e0; display: flex; gap: 0.8rem; flex-wrap: wrap;">
            <button onclick="cancelPreSubmissionReview()" style="background: transparent; color: #2e7d32; border: 2px solid #2e7d32; padding: 0.7rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; flex: 1; min-width: 120px;">
              ‚Üê Back to Quiz
            </button>
            <button onclick="confirmFinalSubmit()" style="background: #4caf50; color: #fff; border: none; padding: 0.7rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; flex: 1; min-width: 120px;">
              Confirm & Submit
            </button>
          </div>
        </div>
      `;

      // Replace the main content with review page
      const reviewContent = summaryHtml + html;
      mainStage.innerHTML = reviewContent;
    }

    function cancelPreSubmissionReview() {
      // Reset mainStage to original flex size (70%)
      const mainStage = document.getElementById('mainStage');
      if (mainStage) {
        mainStage.style.flex = '0 0 70%';
        
        // Restore the original mainStage structure
        mainStage.innerHTML = `
          <div class="timer-section">
            <div class="progress-info">
              Question <span id="currentQuestion">1</span> of <span id="totalQuestions">10</span>
            </div>
          </div>

          <div class="question-content" id="questionContent">
            <!-- Question will be inserted here -->
          </div>

          <div class="control-buttons">
            <button class="btn-nav" id="prevBtn" onclick="previousQuestion()" type="button">‚Üê Previous</button>
            <button class="btn-clear" id="clearBtn" onclick="clearOption()" type="button">Clear</button>
            <button class="btn-nav" id="nextBtn" onclick="nextQuestion()" type="button">Next ‚Üí</button>
            <button class="btn-submit" id="submitBtn" onclick="submitQuiz()" type="button" style="display: none; flex: 1; padding: 0.7rem 1.5rem;">
              <i class="fas fa-check-circle"></i> Submit Quiz
            </button>
          </div>
        `;
      }
      
      // Show the navigator again
      const navigator = document.getElementById('navigator');
      if (navigator) {
        navigator.style.display = 'flex';
      }
      
      // Go back to the question from which submit was clicked
      currentQuestionIndex = submittedFromQuestionIndex;
      displayQuestion();
      updateButtonStates();
      updateNavigator();
    }

    async function confirmFinalSubmit() {
      // Proceed with final submission
      await submitQuiz();
    }

    async function submitQuiz() {
      // Remove quiz-active class from FDC logo when submitting
      const fdcLogoLink = document.getElementById('fdcLogoLink');
      if (fdcLogoLink) {
        fdcLogoLink.classList.remove('quiz-active');
      }
      
      // Show loading overlay
      showLoadingOverlay();
      
      // Simulate processing delay for better UX
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      saveCurrentAnswer();
      isQuizSubmitted = true;
      
      let score = 0;
      userAnswers.forEach((answer, index) => {
        const correctAnswer = questions[index].answer;
        let isCorrect = false;
        
        if (Array.isArray(correctAnswer)) {
          // Multiple correct answers
          if (Array.isArray(answer)) {
            // User selected multiple answers - check if they match exactly
            isCorrect = answer.length === correctAnswer.length && 
                       answer.every(a => correctAnswer.includes(a)) &&
                       correctAnswer.every(c => answer.includes(c));
          } else if (answer !== null) {
            // User selected single answer - check if it's in the correct answers
            isCorrect = correctAnswer.includes(answer);
          }
        } else {
          // Single correct answer
          if (Array.isArray(answer)) {
            // User selected multiple but only one correct - check if any match
            isCorrect = answer.includes(correctAnswer);
          } else {
            // Both single - exact match
            isCorrect = answer === correctAnswer;
          }
        }
        
        if (isCorrect) {
          score++;
        }
      });

      const attempt = {
        employeeName: employeeName,
        employeeGroup: employeeGroup,
        employeeId: employeeId,
        timestamp: new Date().toISOString(),
        score: score,
        totalQuestions: questions.length,
        userAnswers: userAnswers,
        questions: questions
      };

      // Save to Firebase - create a cleaned version without nested arrays
      if (window.saveQuizAttemptToFirebase) {
        try {
          // Convert userAnswers to string to avoid nested arrays
          const firebaseAttempt = {
            employeeName: employeeName,
            employeeGroup: employeeGroup,
            employeeId: employeeId,
            timestamp: new Date().toISOString(),
            score: score,
            totalQuestions: questions.length,
            userAnswersJSON: JSON.stringify(userAnswers)
            // Store as JSON string instead of array to avoid nested arrays
          };
          await window.saveQuizAttemptToFirebase(firebaseAttempt);
        } catch (err) {
          console.error("Firebase save error:", err);
        }
      } else {
        console.warn("Firebase not loaded yet, using localStorage only");
      }

      // Also save to localStorage as backup (with full data)
      let attempts = JSON.parse(localStorage.getItem('quizAttempts') || '[]');
      attempts.push(attempt);
      localStorage.setItem('quizAttempts', JSON.stringify(attempts));

      const percentage = Math.round((score / questions.length) * 100);
      const isPassed = percentage >= 70;

      // Hide loading overlay and show results
      hideLoadingOverlay();
      showPerformanceSummary(score, percentage, isPassed);
      updateResultMap(score);
    }

    function showLoadingOverlay() {
      const overlay = document.createElement('div');
      overlay.className = 'loading-overlay';
      overlay.id = 'loadingOverlay';
      overlay.innerHTML = `
        <div>
          <div class="loading-spinner"></div>
          <div class="loading-text">Evaluating Your Responses...</div>
        </div>
      `;
      document.body.appendChild(overlay);
    }

    function hideLoadingOverlay() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.style.animation = 'fadeOut 0.3s ease forwards';
        setTimeout(() => {
          overlay.remove();
        }, 300);
      }
    }

    function showPerformanceSummary(score, percentage, isPassed) {
      // Hide the navigator
      const navigator = document.getElementById('navigator');
      if (navigator) {
        navigator.style.display = 'none';
      }
      
      // Make mainStage full width
      const mainStage = document.getElementById('mainStage');
      if (mainStage) {
        mainStage.style.flex = '1 1 100%';
      }
      
      const statusClass = isPassed ? 'status-passed' : 'status-failed';
      const statusText = isPassed ? '‚úì PASSED' : '‚úó FAILED';

      const html = `
        <div class="performance-summary">
          <div class="employee-info">
            <strong>${employeeName}</strong> | Group: ${employeeGroup} | ID: ${employeeId}
          </div>
          <div class="summary-header">Assessment Complete!</div>
          <div class="summary-stats">
            <div class="stat-box">
              <div class="stat-label">Score</div>
              <div class="stat-value">${score}/${questions.length}</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Percentage</div>
              <div class="stat-value">${percentage}%</div>
            </div>
          </div>
          <div class="status-badge ${statusClass}">${statusText}</div>
          <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 1rem; border-radius: 6px; margin-top: 1.5rem; margin-bottom: 1.5rem;">
            <div style="color: #1565c0; font-weight: 600; font-size: 0.95rem; line-height: 1.6;">
              <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
              <strong>Important:</strong> If you find any suspicious email or suspicious activity, please contact/consult the IT support immediately. Thank you!
            </div>
          </div>
          <div style="display: flex; gap: 0.8rem; flex-wrap: wrap; justify-content: center;">
            <button class="retake-btn" onclick="showComprehensiveReview()" style="background: #2196f3; flex: 1; min-width: 150px;">
              <i class="fas fa-eye"></i> Review Quiz
            </button>
            <button class="retake-btn" onclick="window.location.href='index.html'" style="flex: 1; min-width: 150px;">
              <i class="fas fa-home"></i> Return to Home
            </button>
          </div>
        </div>
      `;

      mainStage.innerHTML = html;
      
      // Add copyright footer to results page
      appendCopyrightFooter(mainStage);
      
      // Re-enable home icon after submission
      const homeIcon = document.getElementById('homeIcon');
      if (homeIcon) {
        homeIcon.style.display = 'block';
      }
    }

    function updateResultMap(score) {
      const navigatorHeader = navigator.querySelector('.navigator-header');
      navigatorHeader.textContent = 'Result Map';
      
      const navigatorGrid = document.getElementById('navigatorGrid');
      const buttons = navigatorGrid.querySelectorAll('.question-btn');
      
      // Clear all existing onclick handlers first
      buttons.forEach((btn) => {
        btn.removeEventListener('click', btn.reviewClickHandler);
        btn.onclick = null;
      });
      
      buttons.forEach((btn, index) => {
        btn.className = 'question-btn';
        
        if (userAnswers[index] === null) {
          btn.classList.add('unattempted');
        } else if (userAnswers[index] === questions[index].answer) {
          btn.classList.add('correct');
        } else {
          btn.classList.add('incorrect');
        }
        
        // Use a closure to properly capture the index
        const clickHandler = (function(questionIndex) {
          return function(e) {
            e.preventDefault();
            e.stopPropagation();
            reviewQuestion(questionIndex);
          };
        })(index);
        
        btn.reviewClickHandler = clickHandler;
        btn.addEventListener('click', clickHandler, false);
        btn.style.cursor = 'pointer';
      });

      submitBtn.style.display = 'none';
      
      // Hide the navigator submit button when quiz is submitted
      const submitNavBtn = document.getElementById('submitNavBtn');
      if (submitNavBtn) {
        submitNavBtn.style.display = 'none';
      }
      
      let legendElement = navigator.querySelector('.result-legend');
      if (legendElement) {
        legendElement.remove();
      }
      
      const legend = document.createElement('div');
      legend.className = 'result-legend';
      legend.innerHTML = `
        <strong style="display: block; margin-bottom: 0.5rem; color: #222;">Legend:</strong>
        <div class="legend-item">
          <div class="legend-box" style="background: #4caf50; border-color: #4caf50;"></div>
          <span>Correct</span>
        </div>
        <div class="legend-item">
          <div class="legend-box" style="background: #f44336; border-color: #f44336;"></div>
          <span>Incorrect</span>
        </div>
        <div class="legend-item">
          <div class="legend-box" style="background: #ffffff; border-color: #ccc;"></div>
          <span>Unattempted</span>
        </div>
      `;
      navigator.appendChild(legend);
    }

    function reviewQuestion(index) {
      isReviewMode = true;
      currentQuestionIndex = index;
      const question = questions[index];
      const userAnswer = userAnswers[index];
      const correctAnswer = question.answer;
      
      // Check if answer is correct (handle both single and multiple correct answers)
      let isCorrect = false;
      if (Array.isArray(correctAnswer)) {
        // Multiple correct answers - user must match exactly
        if (Array.isArray(userAnswer)) {
          isCorrect = userAnswer.length === correctAnswer.length && 
                     userAnswer.every(a => correctAnswer.includes(a)) &&
                     correctAnswer.every(c => userAnswer.includes(c));
        }
      } else {
        // Single correct answer
        if (Array.isArray(userAnswer)) {
          isCorrect = userAnswer.includes(correctAnswer);
        } else {
          isCorrect = userAnswer === correctAnswer;
        }
      }

      let html = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid #2e7d32;">
          <div style="font-weight: 600; color: #222;">Review Mode - Question ${index + 1}</div>
          <button onclick="exitReview()" style="background: #2e7d32; color: #fff; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">‚Üê Summary</button>
        </div>

        <div class="question-text">Q${index + 1}: ${question.q}</div>
      `;

      if (question.image && question.image.trim()) {
        html += `<img src="${question.image}" alt="Question Image" class="question-image">`;
      }

      html += `<div class="options">`;
      question.options.forEach((opt, j) => {
        let optionStyles = '';
        let labelStyles = '';
        let icon = '';
        let label = '';

        // Determine if this is a correct answer
        const isCorrectOption = Array.isArray(correctAnswer) ? correctAnswer.includes(j) : j === correctAnswer;
        
        // Check if user selected this option
        let userSelectedThis = false;
        if (Array.isArray(userAnswer)) {
          userSelectedThis = userAnswer.includes(j);
        } else {
          userSelectedThis = j === userAnswer;
        }

        if (isCorrectOption && userSelectedThis) {
          // User was correct
          optionStyles = 'background: #e8f5e9 !important; border-color: #4caf50 !important;';
          icon = '<i class="fas fa-check-circle" style="color: #4caf50; margin-right: 0.5rem; font-weight: 700;"></i>';
          label = '<span style="color: #4caf50; font-weight: 700; margin-left: 0.5rem;">(Your Choice ‚úì)</span>';
        } else if (isCorrectOption) {
          // Show correct answer when user was wrong
          optionStyles = 'background: #e8f5e9 !important; border-color: #4caf50 !important;';
          icon = '<i class="fas fa-check-circle" style="color: #4caf50; margin-right: 0.5rem; font-weight: 700;"></i>';
          label = '<span style="color: #4caf50; font-weight: 700; margin-left: 0.5rem;">(Correct Answer)</span>';
        } else if (userSelectedThis && !isCorrect) {
          // Highlight user's wrong choice
          optionStyles = 'background: #ffebee !important; border-color: #f44336 !important;';
          icon = '<i class="fas fa-times-circle" style="color: #f44336; margin-right: 0.5rem; font-weight: 700;"></i>';
          label = '<span style="color: #f44336; font-weight: 700; margin-left: 0.5rem;">(Your Choice ‚úó)</span>';
        }

        html += `
          <label style="${optionStyles}" style="pointer-events: none; opacity: 1;">
            <input type="radio" disabled ${userSelectedThis ? 'checked' : ''} style="margin-right: 0.75rem; cursor: not-allowed;">
            ${icon}
            ${opt}
            ${label}
          </label>
        `;
      });
      html += `</div>`;

      // Explanation Box
      const resultText = isCorrect ? 'You got this question right!' : 'You answered this question incorrectly.';
      const resultColor = isCorrect ? '#4caf50' : '#f44336';
      const resultBgColor = isCorrect ? '#e8f5e9' : '#ffebee';
      const borderColor = isCorrect ? '#4caf50' : '#f44336';

      // Get correct answer text
      let correctAnswerText = '';
      if (Array.isArray(correctAnswer)) {
        correctAnswerText = correctAnswer.map(idx => question.options[idx]).join(', ');
      } else {
        correctAnswerText = question.options[correctAnswer];
      }

      let userAnswerText = '';
      if (!isCorrect) {
        if (Array.isArray(userAnswer) && userAnswer.length > 0) {
          userAnswerText = userAnswer.map(idx => question.options[idx]).join(', ');
        } else if (userAnswer !== null && !Array.isArray(userAnswer)) {
          userAnswerText = question.options[userAnswer];
        }
      }

      html += `
        <div style="background: ${resultBgColor}; border-left: 4px solid ${borderColor}; padding: 1rem; border-radius: 6px; margin-top: 1.5rem; margin-bottom: 1rem;">
          <div style="font-weight: 700; color: ${resultColor}; margin-bottom: 0.5rem; font-size: 1rem;">
            ${resultText}
          </div>
          <div style="color: #333; font-size: 0.9rem; line-height: 1.6;">
            <strong>Correct Answer:</strong> ${correctAnswerText}
          </div>
          ${!isCorrect && userAnswerText ? `<div style="color: #333; font-size: 0.9rem; line-height: 1.6; margin-top: 0.5rem;"><strong>Your Answer:</strong> ${userAnswerText}</div>` : ''}
        </div>
      `;

      html += `
        <div style="display: flex; gap: 0.8rem; justify-content: center; margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #e0e0e0;">
          <button onclick="reviewPrevious()" ${index === 0 ? 'disabled' : ''} style="background: #2e7d32; color: #fff; border: none; padding: 0.7rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; ${index === 0 ? 'opacity: 0.5; cursor: not-allowed;' : ''}">‚Üê Previous</button>
          <button onclick="reviewNext()" ${index === questions.length - 1 ? 'disabled' : ''} style="background: #2e7d32; color: #fff; border: none; padding: 0.7rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; ${index === questions.length - 1 ? 'opacity: 0.5; cursor: not-allowed;' : ''}">Next ‚Üí</button>
        </div>
      `;

      questionContent.innerHTML = html;
      updateReviewNavigator();
    }

    function reviewPrevious() {
      if (currentQuestionIndex > 0) {
        reviewQuestion(currentQuestionIndex - 1);
      }
    }

    function reviewNext() {
      if (currentQuestionIndex < questions.length - 1) {
        reviewQuestion(currentQuestionIndex + 1);
      }
    }

    function updateReviewNavigator() {
      questions.forEach((question, index) => {
        const btn = document.getElementById(`q-btn-${index}`);
        btn.classList.remove('current');
        btn.style.boxShadow = 'none';
        
        if (index === currentQuestionIndex) {
          btn.classList.add('current');
        }
      });
    }

    function exitReview() {
      isReviewMode = false;
      const score = userAnswers.filter((ans, idx) => ans === questions[idx].answer).length;
      const percentage = Math.round((score / questions.length) * 100);
      const isPassed = percentage >= 70;
      showPerformanceSummary(score, percentage, isPassed);
    }

    function goBackToQuiz() {
      // Hide comprehensive review and show quiz questions
      mainStage.innerHTML = '';
      document.getElementById('quizWrapper').style.display = 'flex';
      buildNavigator();
      currentQuestionIndex = 0;
      displayQuestion();
    }

    function showComprehensiveReview() {
      let html = `
        <div style="overflow-y: auto; height: 100%; display: flex; flex-direction: column;">
          <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid #2e7d32; flex-shrink: 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
              <div style="font-weight: 600; color: #2e7d32; font-size: 1.1rem;">Complete Quiz Review</div>
              <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button onclick="exitComprehensiveReview()" style="background: #2e7d32; color: #fff; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">‚Üê Back to Summary</button>
                <button onclick="goBackToQuiz()" style="background: #1565c0; color: #fff; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">‚Üê Back to Quiz</button>
              </div>
            </div>
          </div>
          <div style="flex: 1; overflow-y: auto; padding-right: 0.5rem;">
      `;

      questions.forEach((question, index) => {
        const userAnswer = userAnswers[index];
        const correctAnswer = question.answer;
        
        // Handle both single and multiple correct answers
        let isCorrect = false;
        if (Array.isArray(correctAnswer)) {
          isCorrect = correctAnswer.includes(userAnswer);
        } else {
          isCorrect = userAnswer === correctAnswer;
        }
        const isUnattempted = userAnswer === null;

        let statusBadge = '';
        let statusColor = '';
        if (isUnattempted) {
          statusBadge = 'Not Attempted';
          statusColor = '#999';
        } else if (isCorrect) {
          statusBadge = '‚úì Correct';
          statusColor = '#4caf50';
        } else {
          statusBadge = '‚úó Incorrect';
          statusColor = '#f44336';
        }

        html += `
          <div style="background: #f9f9f9; border-left: 4px solid ${statusColor}; padding: 1.2rem; margin-bottom: 1rem; border-radius: 6px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
              <div style="font-weight: 700; color: #2e7d32; font-size: 1rem;">Q${index + 1}: ${question.q}</div>
              <div style="background: ${statusColor}; color: #fff; padding: 0.4rem 0.8rem; border-radius: 4px; font-weight: 600; font-size: 0.85rem;">${statusBadge}</div>
            </div>
        `;

        if (question.image && question.image.trim()) {
          html += `<img src="${question.image}" alt="Question Image" style="width: 100%; max-height: 120px; object-fit: contain; border-radius: 4px; margin-bottom: 1rem;">`;
        }

        html += `<div style="background: #fff; border: 1px solid #e0e0e0; border-radius: 4px; padding: 1rem;">`;

        // Show all options with highlighting
        question.options.forEach((option, optIndex) => {
          let optStyle = '';
          let icon = '';

          if (optIndex === correctAnswer && optIndex === userAnswer) {
            optStyle = 'background: #e8f5e9; border-left: 3px solid #4caf50;';
            icon = '<i class="fas fa-check-circle" style="color: #4caf50; margin-right: 0.5rem;"></i>';
          } else if (optIndex === correctAnswer) {
            optStyle = 'background: #e8f5e9; border-left: 3px solid #4caf50;';
            icon = '<i class="fas fa-check-circle" style="color: #4caf50; margin-right: 0.5rem;"></i>';
          } else if (optIndex === userAnswer && !isCorrect) {
            optStyle = 'background: #ffebee; border-left: 3px solid #f44336;';
            icon = '<i class="fas fa-times-circle" style="color: #f44336; margin-right: 0.5rem;"></i>';
          }

          let label = '';
          if (optIndex === correctAnswer && optIndex === userAnswer) {
            label = '<span style="color: #4caf50; font-weight: 600; margin-left: auto;">(Your Answer - Correct)</span>';
          } else if (optIndex === correctAnswer) {
            label = '<span style="color: #4caf50; font-weight: 600; margin-left: auto;">(Correct Answer)</span>';
          } else if (optIndex === userAnswer && !isCorrect) {
            label = '<span style="color: #f44336; font-weight: 600; margin-left: auto;">(Your Answer)</span>';
          }

          html += `
            <div style="padding: 0.8rem; margin-bottom: 0.5rem; border-radius: 4px; display: flex; align-items: center; ${optStyle}">
              ${icon}
              <span>${option}</span>
              ${label}
            </div>
          `;
        });

        html += `</div>`;

        // Summary box
        if (isUnattempted) {
          html += `
            <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 0.8rem; margin-top: 1rem; border-radius: 4px;">
              <strong style="color: #ff9800;">Not Attempted</strong> - You did not select an answer for this question.
            </div>
          `;
        } else if (isCorrect) {
          html += `
            <div style="background: #e8f5e9; border-left: 4px solid #4caf50; padding: 0.8rem; margin-top: 1rem; border-radius: 4px;">
              <strong style="color: #4caf50;">Correct!</strong> Your answer matched the correct answer: <strong>${question.options[correctAnswer]}</strong>
            </div>
          `;
        } else {
          html += `
            <div style="background: #ffebee; border-left: 4px solid #f44336; padding: 0.8rem; margin-top: 1rem; border-radius: 4px;">
              <strong style="color: #f44336;">Incorrect</strong><br>
              Your answer: <strong>${question.options[userAnswer]}</strong><br>
              Correct answer: <strong>${question.options[correctAnswer]}</strong>
            </div>
          `;
        }

        html += `</div>`;
      });

      html += `</div></div>`;

      mainStage.innerHTML = html;
    }

    function exitComprehensiveReview() {
      const score = userAnswers.filter((ans, idx) => ans === questions[idx].answer).length;
      const percentage = Math.round((score / questions.length) * 100);
      const isPassed = percentage >= 70;
      showPerformanceSummary(score, percentage, isPassed);
    }

    function exitQuiz() {
      if (isQuizSubmitted) {
        // Quiz already submitted, allow exit
        clearInterval(timerInterval);
        window.location.href = "index.html";
      } else {
        // Quiz not submitted, prevent exit
        alert('Please submit the quiz before exiting. You cannot leave without submitting.');
      }
    }

    function goBack() {
      clearInterval(timerInterval);
      window.location.href = "index.html";
    }

    function appendCopyrightFooter(containerElement) {
      // Check if copyright already exists
      if (containerElement.querySelector('.copyright-footer')) {
        return;
      }
      const copyrightFooter = document.createElement('div');
      copyrightFooter.className = 'copyright-footer';
      copyrightFooter.style.marginTop = '2rem';
      copyrightFooter.textContent = 'Copyright ¬© 2025 FDC | All Rights Reserved.';
      containerElement.appendChild(copyrightFooter);
    }
  </script>

  <!-- Firebase Module Script -->
  <script type="module">
    import { db, collection, addDoc, fetchCustomQuestionsFromFirebase } from './firebase.js';
    
    // Export custom questions fetcher to window
    window.fetchCustomQuestionsFromFirebase = fetchCustomQuestionsFromFirebase;
    
    window.saveQuizAttemptToFirebase = async function(attemptData) {
      try {
        console.log("üìù Saving quiz attempt to Firebase...");
        console.log("Employee:", attemptData.employeeName);
        console.log("Score:", attemptData.score + "/" + attemptData.totalQuestions);
        
        const docRef = await addDoc(collection(db, "quizAttempts"), attemptData);
        console.log("‚úÖ Quiz attempt saved to Firebase with ID:", docRef.id);
        alert("‚úÖ Your quiz has been submitted and saved to the database!");
        return true;
      } catch (error) {
        console.error("‚ùå Error saving to Firebase:", error);
        console.error("Error message:", error.message);
        console.error("Error code:", error.code);
        alert("‚ö†Ô∏è Error saving to database, but your response was recorded locally.");
        return false;
      }
    };

    console.log("üî• Firebase module loaded on quiz.html");
    console.log("üí° Quiz submissions will be saved to Firebase automatically");
  </script>
</body>
</html>
