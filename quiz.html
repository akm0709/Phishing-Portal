<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Phishing Awareness Quiz</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: #222;
    }

    .home-icon {
      position: fixed;
      top: 1.5rem;
      left: 1.5rem;
      width: 3rem;
      height: 3rem;
      background: #2e7d32;
      color: #fff;
      border: 2px solid #2e7d32;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 1000;
      text-decoration: none;
      box-shadow: 0 2px 8px rgba(46, 125, 50, 0.2);
    }

    .home-icon:hover {
      background: #fff;
      color: #2e7d32;
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
    }

    canvas#matrix {
      display: none;
    }

    /* Employee Form Styles */
    .quiz-container {
      max-width: 900px;
      margin: 4rem auto;
      background-color: #ffffff;
      padding: 2rem;
      border-radius: 8px;
      border: 2px solid #2e7d32;
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.1);
      animation: fadeIn 1s ease;
      z-index: 1;
    }

    h1 {
      text-align: center;
      color: #2e7d32;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin-bottom: 2rem;
      text-shadow: none;
      font-weight: 700;
      font-size: 2rem;
    }

    /* Split Screen Layout */
    .split-screen-wrapper {
      display: flex;
      gap: 1rem;
      padding: 1.5rem;
      background: #f5f5f5;
      min-height: 100vh;
      margin-top: 5rem;
    }

    .main-stage {
      flex: 0 0 70%;
      background: #ffffff;
      padding: 2rem;
      border-radius: 8px;
      border: 2px solid #2e7d32;
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.1);
      display: flex;
      flex-direction: column;
    }

    .question-navigator {
      flex: 0 0 30%;
      background: #ffffff;
      padding: 1rem;
      border-radius: 8px;
      border: 2px solid #2e7d32;
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Main Stage Content */
    .timer-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #2e7d32;
    }

    .progress-info {
      font-size: 0.95rem;
      color: #222;
      font-weight: 600;
    }

    .timer {
      font-size: 1.3rem;
      font-weight: 700;
      color: #2e7d32;
      padding: 0.5rem 1rem;
      border: 2px solid #2e7d32;
      border-radius: 6px;
      min-width: 70px;
      text-align: center;
    }

    .timer.warning {
      color: #ff9800;
      border-color: #ff9800;
    }

    .timer.danger {
      color: #c62828;
      border-color: #c62828;
    }

    .question-content {
      flex: 1;
      overflow: hidden;
      margin-bottom: 1.5rem;
      display: flex;
      flex-direction: column;
    }

    .question-text {
      font-size: 1.1rem;
      color: #222;
      font-weight: 600;
      margin-bottom: 1rem;
      line-height: 1.6;
      flex-shrink: 0;
    }

    .question-image {
      width: 100%;
      max-height: 150px;
      object-fit: contain;
      border-radius: 6px;
      border: 2px solid #2e7d32;
      margin-bottom: 1rem;
      flex-shrink: 0;
    }

    .options {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      overflow-y: auto;
      flex: 1;
      padding-right: 0.5rem;
    }

    .options label {
      display: flex;
      align-items: flex-start;
      background: #f9f9f9;
      border: 2px solid #e0e0e0;
      padding: 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #222;
      font-size: 0.9rem;
      line-height: 1.4;
      flex-shrink: 0;
    }

    .options label:hover {
      background: #f0f7f0;
      border-color: #2e7d32;
      transform: translateX(4px);
    }

    .options input[type="radio"] {
      margin-right: 0.75rem;
      margin-top: 0.2rem;
      cursor: pointer;
      width: 18px;
      height: 18px;
    }

    .options label.selected {
      background: #e8f5e9;
      border-color: #2e7d32;
      font-weight: 600;
    }

    .control-buttons {
      display: flex;
      gap: 0.8rem;
      justify-content: center;
      flex-wrap: wrap;
      padding-top: 1rem;
      border-top: 2px solid #e0e0e0;
    }

    .btn-nav, .btn-action {
      padding: 0.7rem 1.2rem;
      font-size: 0.95rem;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      white-space: nowrap;
    }

    .btn-nav {
      background: #2e7d32;
      color: #fff;
    }

    .btn-nav:hover:not(:disabled) {
      background: #1b4620;
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(46, 125, 50, 0.2);
    }

    .btn-nav:disabled {
      background: #ccc;
      color: #888;
      cursor: not-allowed;
    }

    .btn-clear {
      background: transparent;
      color: #2e7d32;
      border: 2px solid #2e7d32;
    }

    .btn-clear:hover {
      background: #2e7d32;
      color: #fff;
      transform: translateY(-2px);
    }

    .btn-submit {
      background: #4caf50;
      color: #fff;
      border: none;
      padding: 0.7rem 1.5rem;
      font-size: 0.9rem;
      font-weight: 700;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      flex-shrink: 0;
      white-space: nowrap;
    }

    .btn-submit:hover {
      background: #388e3c;
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
    }

    .btn-exit {
      background: transparent;
      color: #2e7d32;
      border: 2px solid #2e7d32;
      width: 100%;
      padding: 0.6rem;
      margin-top: 0.4rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      flex-shrink: 0;
      font-size: 0.85rem;
    }

    .btn-exit:hover {
      background: #2e7d32;
      color: #fff;
    }

    /* Question Navigator Styles */
    .navigator-header {
      font-weight: 700;
      font-size: 0.9rem;
      color: #2e7d32;
      margin-bottom: 0.8rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #2e7d32;
    }

    .navigator-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.6rem;
      flex: 0;
    }

    .question-btn {
      aspect-ratio: 1;
      border: 2px solid #e0e0e0;
      background: #ffffff;
      color: #222;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.75rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 35px;
    }

    .question-btn:hover {
      border-color: #2e7d32;
      background: #f9f9f9;
    }

    /* Question States */
    .question-btn.unattempted {
      background: #ffffff;
      border: 2px solid #ccc;
      color: #999;
    }

    .question-btn.answered {
      background: #e3f2fd;
      border: 2px solid #2196f3;
      color: #2196f3;
    }

    .question-btn.current {
      background: #2e7d32;
      color: #fff;
      border: 2px solid #2e7d32;
      box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.2);
      font-size: 0.9rem;
    }

    .question-btn.correct {
      background: #4caf50;
      color: #fff;
      border: 2px solid #4caf50;
    }

    .question-btn.incorrect {
      background: #f44336;
      color: #fff;
      border: 2px solid #f44336;
    }

    /* Performance Summary */
    .performance-summary {
      text-align: center;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .summary-header {
      font-size: 1.8rem;
      color: #2e7d32;
      font-weight: 700;
      margin-bottom: 1.5rem;
    }

    .summary-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-box {
      background: #f9f9f9;
      padding: 1.5rem;
      border-radius: 6px;
      border: 2px solid #e0e0e0;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .stat-value {
      font-size: 1.8rem;
      color: #2e7d32;
      font-weight: 700;
    }

    .status-badge {
      font-size: 1.3rem;
      font-weight: 700;
      padding: 1rem 2rem;
      border-radius: 6px;
      margin: 1.5rem 0;
      display: inline-block;
    }

    .status-passed {
      background: #e8f5e9;
      color: #2e7d32;
      border: 2px solid #4caf50;
    }

    .status-failed {
      background: #ffebee;
      color: #c62828;
      border: 2px solid #f44336;
    }

    .employee-info {
      background: #f5f5f5;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
    }

    .retake-btn {
      background: #2e7d32;
      color: #fff;
      padding: 0.9rem 2rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 700;
      font-size: 1rem;
      margin-top: 1rem;
      transition: all 0.3s ease;
    }

    .retake-btn:hover {
      background: #1b4620;
      transform: translateY(-2px);
    }

    /* Result Map Legend */
    .result-legend {
      font-size: 0.85rem;
      color: #666;
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid #e0e0e0;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.4rem 0;
      justify-content: center;
    }

    .legend-box {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 2px solid;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .split-screen-wrapper {
        flex-direction: column;
      }

      .main-stage {
        flex: 1 1 100%;
      }

      .question-navigator {
        flex: 0 1 auto;
        max-height: auto;
      }

      .navigator-grid {
        grid-template-columns: repeat(6, 1fr);
        max-width: 500px;
        margin: 0 auto;
      }
    }

    @media (max-width: 768px) {
      .split-screen-wrapper {
        padding: 0.5rem;
      }

      .main-stage {
        padding: 1rem;
      }

      .question-navigator {
        padding: 1rem;
      }

      .navigator-grid {
        grid-template-columns: repeat(5, 1fr);
      }

      .summary-stats {
        grid-template-columns: 1fr;
      }
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <a href="index.html" class="home-icon" title="Back to Home">
    <i class="fas fa-home"></i>
  </a>
  
  <canvas id="matrix"></canvas>

  <!-- Employee Information Form -->
  <div class="quiz-container" id="employeeForm">
    <h1>Employee Information</h1>
    <form onsubmit="startQuiz(event)" id="empForm">
      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; color: #2e7d32; font-weight: 600;">Employee Name</label>
        <input type="text" id="employeeName" placeholder="Enter your full name" required style="width: 100%; padding: 0.8rem; border: 1px solid #2e7d32; border-radius: 6px; font-size: 1rem; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; margin-bottom: 0.5rem; color: #2e7d32; font-weight: 600;">Employee ID</label>
        <input type="text" id="employeeId" placeholder="Enter your employee ID" required style="width: 100%; padding: 0.8rem; border: 1px solid #2e7d32; border-radius: 6px; font-size: 1rem; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
      </div>
      <button type="submit" style="width: 100%; padding: 0.8rem; background: #2e7d32; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">Start Quiz</button>
      <button type="button" onclick="goBack()" style="width: 100%; margin-top: 0.5rem; padding: 0.8rem; background: transparent; color: #2e7d32; border: 2px solid #2e7d32; border-radius: 6px; cursor: pointer; font-weight: 600; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">Back to Home</button>
    </form>
  </div>

  <!-- Split Screen Quiz Interface -->
  <div class="split-screen-wrapper" id="quizWrapper" style="display: none;">
    
    <!-- Main Question Stage (Left Panel - 70%) -->
    <div class="main-stage" id="mainStage">
      <div class="timer-section">
        <div class="progress-info">
          Question <span id="currentQuestion">1</span> of <span id="totalQuestions">10</span>
        </div>
        <div class="timer" id="timer">60</div>
      </div>

      <div class="question-content" id="questionContent">
        <!-- Question will be inserted here -->
      </div>

      <div class="control-buttons">
        <button class="btn-nav" id="prevBtn" onclick="previousQuestion()" type="button">‚Üê Previous</button>
        <button class="btn-clear" id="clearBtn" onclick="clearOption()" type="button">Clear</button>
        <button class="btn-nav" id="nextBtn" onclick="nextQuestion()" type="button">Next ‚Üí</button>
        <button class="btn-submit" id="submitBtn" onclick="submitQuiz()" type="button" style="display: none; flex: 1; padding: 0.7rem 1.5rem;">
          <i class="fas fa-check-circle"></i> Submit Quiz
        </button>
      </div>
    </div>

    <!-- Question Navigator (Right Panel - 30%) -->
    <div class="question-navigator" id="navigator">
      <div class="navigator-header">Question Navigator</div>
      <div class="navigator-grid" id="navigatorGrid">
        <!-- Question buttons will be generated here -->
      </div>
      <button class="btn-exit" onclick="exitQuiz()" type="button">Exit Quiz</button>
    </div>
  </div>

  <script>
    const questions = [
      {
        q: "You receive an email from your bank asking to confirm your login info via a link. What do you do?",
        options: [
          "Click the link and enter info",
          "Ignore it",
          "Contact bank using official site",
          "Forward it to a friend"
        ],
        answer: 2
      },
      {
        q: "Which of these is a common sign of a phishing attempt?",
        options: [
          "Personalized greeting",
          "Unusual sender address",
          "Secure https link",
          "Familiar company logo"
        ],
        answer: 1
      },
      {
        q: "What is the safest way to verify a suspicious link?",
        options: [
          "Click it and see",
          "Check hover preview",
          "Ask in comments",
          "Guess based on URL"
        ],
        answer: 1
      },
      {
        q: "You get a message saying you won a prize and need to pay a fee to claim it. What's the best action?",
        options: [
          "Pay quickly",
          "Reply with details",
          "Ignore or report it",
          "Try it for fun"
        ],
        answer: 2
      },
      {
        q: "Which of the following is NOT recommended to prevent phishing?",
        options: [
          "Use multi-factor authentication",
          "Ignore security updates",
          "Verify URLs",
          "Check email sender"
        ],
        answer: 1
      },
      {
        q: "Why is it risky to reuse the same password?",
        options: [
          "Slower typing",
          "Harder to remember",
          "One breach = all accounts compromised",
          "Sites require changes"
        ],
        answer: 2
      },
      {
        q: "What should you do if you clicked a phishing link by mistake?",
        options: [
          "Nothing, it's fine",
          "Tell friends",
          "Change passwords, scan device",
          "Buy antivirus"
        ],
        answer: 2
      },
      {
        q: "An email urges urgent action and threatens account closure. You should:",
        options: [
          "Panic and act",
          "Click fast",
          "Verify via official contact",
          "Reply to email"
        ],
        answer: 2
      },
      {
        q: "Which type of file is MOST likely to carry phishing malware?",
        options: [
          ".jpg",
          ".docx",
          ".mp3",
          ".txt"
        ],
        answer: 1
      },
      {
        q: "What's the best defense against phishing?",
        options: [
          "Being skeptical and aware",
          "Fast clicking",
          "Trusting everyone",
          "Avoiding the internet"
        ],
        answer: 0
      }
    ];

    let currentQuestionIndex = 0;
    let userAnswers = new Array(questions.length).fill(null);
    let timerInterval;
    let timeRemaining = 60;
    let employeeName = '';
    let employeeId = '';
    let isQuizSubmitted = false;
    let isReviewMode = false;

    const questionContent = document.getElementById("questionContent");
    const currentQuestionSpan = document.getElementById("currentQuestion");
    const totalQuestionsSpan = document.getElementById("totalQuestions");
    const timerDisplay = document.getElementById("timer");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const submitBtn = document.getElementById("submitBtn");
    const clearBtn = document.getElementById("clearBtn");
    const mainStage = document.getElementById("mainStage");
    const navigator = document.getElementById("navigator");

    totalQuestionsSpan.textContent = questions.length;

    function loadAllQuestions() {
      const customQuestions = localStorage.getItem('customQuestions');
      if (customQuestions) {
        const custom = JSON.parse(customQuestions);
        questions.push(...custom);
        userAnswers = new Array(questions.length).fill(null);
        totalQuestionsSpan.textContent = questions.length;
      }
    }

    function startQuiz(event) {
      event.preventDefault();
      employeeName = document.getElementById('employeeName').value;
      employeeId = document.getElementById('employeeId').value;
      
      document.getElementById('employeeForm').style.display = 'none';
      document.getElementById('quizWrapper').style.display = 'flex';
      
      loadAllQuestions();
      buildNavigator();
      displayQuestion();
    }

    function buildNavigator() {
      const navigatorGrid = document.getElementById('navigatorGrid');
      navigatorGrid.innerHTML = '';
      
      questions.forEach((_, index) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = index + 1;
        btn.className = 'question-btn unattempted';
        btn.id = `q-btn-${index}`;
        btn.onclick = () => jumpToQuestion(index);
        navigatorGrid.appendChild(btn);
      });
      
      updateNavigator();
    }

    function updateNavigator() {
      questions.forEach((_, index) => {
        const btn = document.getElementById(`q-btn-${index}`);
        btn.className = 'question-btn';
        
        if (index === currentQuestionIndex) {
          btn.classList.add('current');
        } else if (userAnswers[index] !== null) {
          btn.classList.add('answered');
        } else {
          btn.classList.add('unattempted');
        }
      });
    }

    function jumpToQuestion(index) {
      if (isQuizSubmitted) return;
      saveCurrentAnswer();
      currentQuestionIndex = index;
      displayQuestion();
    }

    function displayQuestion() {
      const question = questions[currentQuestionIndex];
      currentQuestionSpan.textContent = currentQuestionIndex + 1;
      
      // Check if this question has multiple correct answers
      const hasMultipleAnswers = Array.isArray(question.answer);
      
      let html = `
        <div class="question-text">Q${currentQuestionIndex + 1}: ${question.q}</div>
      `;
      
      if (question.image && question.image.trim()) {
        html += `<img src="${question.image}" alt="Question Image" class="question-image">`;
      }
      
      html += `<div class="options">`;
      question.options.forEach((opt, j) => {
        let isSelected = false;
        let checkedAttr = '';
        let selectedClass = '';
        
        if (hasMultipleAnswers) {
          // For multiple answers, userAnswers is an array
          isSelected = Array.isArray(userAnswers[currentQuestionIndex]) && userAnswers[currentQuestionIndex].includes(j);
          checkedAttr = isSelected ? 'checked' : '';
          selectedClass = isSelected ? 'selected' : '';
          
          html += `
            <label class="${selectedClass}">
              <input type="checkbox" name="currentQuestion" value="${j}" ${checkedAttr} onchange="handleOptionSelect(${j}, ${hasMultipleAnswers})">
              ${opt}
            </label>
          `;
        } else {
          // For single answer, keep radio button behavior
          isSelected = userAnswers[currentQuestionIndex] === j;
          checkedAttr = isSelected ? 'checked' : '';
          selectedClass = isSelected ? 'selected' : '';
          
          html += `
            <label class="${selectedClass}">
              <input type="radio" name="currentQuestion" value="${j}" ${checkedAttr} onchange="handleOptionSelect(${j}, false)">
              ${opt}
            </label>
          `;
        }
      });
      html += `</div>`;
      
      questionContent.innerHTML = html;
      updateButtonStates();
      updateNavigator();
      resetTimer();
      startTimer();
    }

    function handleOptionSelect(optionIndex, isMultiple) {
      if (isMultiple) {
        // For multiple answers, manage array
        if (!Array.isArray(userAnswers[currentQuestionIndex])) {
          userAnswers[currentQuestionIndex] = [];
        }
        
        const checkbox = document.querySelector(`input[name="currentQuestion"][value="${optionIndex}"]`);
        if (checkbox.checked) {
          if (!userAnswers[currentQuestionIndex].includes(optionIndex)) {
            userAnswers[currentQuestionIndex].push(optionIndex);
          }
        } else {
          userAnswers[currentQuestionIndex] = userAnswers[currentQuestionIndex].filter(idx => idx !== optionIndex);
        }
      } else {
        // For single answer, keep original behavior
        userAnswers[currentQuestionIndex] = optionIndex;
        
        const labels = document.querySelectorAll('.options label');
        labels.forEach((label, idx) => {
          if (idx === optionIndex) {
            label.classList.add('selected');
          } else {
            label.classList.remove('selected');
          }
        });
        return; // Early return to avoid the selected class logic below
      }
      
      // Update selected class for multiple answer questions
      const labels = document.querySelectorAll('.options label');
      labels.forEach((label, idx) => {
        const isChecked = document.querySelector(`input[name="currentQuestion"][value="${idx}"]`).checked;
        if (isChecked) {
          label.classList.add('selected');
        } else {
          label.classList.remove('selected');
        }
      });
      
      updateNavigator();
    }

    function updateButtonStates() {
      prevBtn.disabled = currentQuestionIndex === 0;
      nextBtn.style.display = currentQuestionIndex === questions.length - 1 ? 'none' : 'block';
      submitBtn.style.display = currentQuestionIndex === questions.length - 1 ? 'block' : 'none';
    }

    function saveCurrentAnswer() {
      const question = questions[currentQuestionIndex];
      const hasMultipleAnswers = Array.isArray(question.answer);
      
      if (hasMultipleAnswers) {
        // For multiple answers, collect all checked checkboxes
        const selectedOptions = document.querySelectorAll('input[name="currentQuestion"]:checked');
        if (selectedOptions.length > 0) {
          userAnswers[currentQuestionIndex] = Array.from(selectedOptions).map(opt => parseInt(opt.value));
        } else {
          userAnswers[currentQuestionIndex] = null;
        }
      } else {
        // For single answer, keep original behavior
        const selectedOption = document.querySelector('input[name="currentQuestion"]:checked');
        if (selectedOption) {
          userAnswers[currentQuestionIndex] = parseInt(selectedOption.value);
        } else {
          userAnswers[currentQuestionIndex] = null;
        }
      }
    }

    function nextQuestion() {
      saveCurrentAnswer();
      if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        displayQuestion();
      }
    }

    function previousQuestion() {
      saveCurrentAnswer();
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        displayQuestion();
      }
    }

    function clearOption() {
      userAnswers[currentQuestionIndex] = null;
      const inputs = document.querySelectorAll('input[name="currentQuestion"]');
      inputs.forEach(input => input.checked = false);
      document.querySelectorAll('.options label').forEach(label => label.classList.remove('selected'));
      updateNavigator();
    }

    function resetTimer() {
      timeRemaining = 60;
      timerDisplay.textContent = "60";
      timerDisplay.classList.remove('warning', 'danger');
    }

    function startTimer() {
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeRemaining--;
        timerDisplay.textContent = timeRemaining;

        if (timeRemaining <= 20 && timeRemaining > 10) {
          timerDisplay.classList.add('warning');
          timerDisplay.classList.remove('danger');
        } else if (timeRemaining <= 10) {
          timerDisplay.classList.add('danger');
          timerDisplay.classList.remove('warning');
        }

        if (timeRemaining === 0) {
          clearInterval(timerInterval);
          const quizWrapper = document.getElementById('quizWrapper');
          if (quizWrapper && quizWrapper.style.display !== 'none' && currentQuestionIndex < questions.length - 1) {
            alert("Time's up for this question! Moving to next question.");
            nextQuestion();
          }
        }
      }, 1000);
    }

    async function submitQuiz() {
      saveCurrentAnswer();
      clearInterval(timerInterval);
      isQuizSubmitted = true;
      
      let score = 0;
      userAnswers.forEach((answer, index) => {
        const correctAnswer = questions[index].answer;
        let isCorrect = false;
        
        if (Array.isArray(correctAnswer)) {
          // Multiple correct answers
          if (Array.isArray(answer)) {
            // User selected multiple answers - check if they match exactly
            isCorrect = answer.length === correctAnswer.length && 
                       answer.every(a => correctAnswer.includes(a)) &&
                       correctAnswer.every(c => answer.includes(c));
          } else if (answer !== null) {
            // User selected single answer - check if it's in the correct answers
            isCorrect = correctAnswer.includes(answer);
          }
        } else {
          // Single correct answer
          if (Array.isArray(answer)) {
            // User selected multiple but only one correct - check if any match
            isCorrect = answer.includes(correctAnswer);
          } else {
            // Both single - exact match
            isCorrect = answer === correctAnswer;
          }
        }
        
        if (isCorrect) {
          score++;
        }
      });

      const attempt = {
        employeeName: employeeName,
        employeeId: employeeId,
        timestamp: new Date().toISOString(),
        score: score,
        totalQuestions: questions.length,
        userAnswers: userAnswers,
        questions: questions
      };

      // Save to Firebase - create a cleaned version without nested arrays
      if (window.saveQuizAttemptToFirebase) {
        try {
          // Convert userAnswers to string to avoid nested arrays
          const firebaseAttempt = {
            employeeName: employeeName,
            employeeId: employeeId,
            timestamp: new Date().toISOString(),
            score: score,
            totalQuestions: questions.length,
            userAnswersJSON: JSON.stringify(userAnswers)
            // Store as JSON string instead of array to avoid nested arrays
          };
          await window.saveQuizAttemptToFirebase(firebaseAttempt);
        } catch (err) {
          console.error("Firebase save error:", err);
        }
      } else {
        console.warn("Firebase not loaded yet, using localStorage only");
      }

      // Also save to localStorage as backup (with full data)
      let attempts = JSON.parse(localStorage.getItem('quizAttempts') || '[]');
      attempts.push(attempt);
      localStorage.setItem('quizAttempts', JSON.stringify(attempts));

      const percentage = Math.round((score / questions.length) * 100);
      const isPassed = percentage >= 70;

      showPerformanceSummary(score, percentage, isPassed);
      updateResultMap(score);
    }

    function showPerformanceSummary(score, percentage, isPassed) {
      const statusClass = isPassed ? 'status-passed' : 'status-failed';
      const statusText = isPassed ? '‚úì PASSED' : '‚úó FAILED';

      const html = `
        <div class="performance-summary">
          <div class="employee-info">
            <strong>${employeeName}</strong> | ID: ${employeeId}
          </div>
          <div class="summary-header">Assessment Complete!</div>
          <div class="summary-stats">
            <div class="stat-box">
              <div class="stat-label">Score</div>
              <div class="stat-value">${score}/${questions.length}</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Percentage</div>
              <div class="stat-value">${percentage}%</div>
            </div>
          </div>
          <div class="status-badge ${statusClass}">${statusText}</div>
          <div style="display: flex; gap: 0.8rem; flex-wrap: wrap; justify-content: center; margin-top: 1.5rem;">
            <button class="retake-btn" onclick="showComprehensiveReview()" style="background: #2196f3; flex: 1; min-width: 150px;">
              <i class="fas fa-eye"></i> Review Quiz
            </button>
            <button class="retake-btn" onclick="location.reload()" style="flex: 1; min-width: 150px;">
              <i class="fas fa-redo"></i> Retake Quiz
            </button>
          </div>
        </div>
      `;

      mainStage.innerHTML = html;
    }

    function updateResultMap(score) {
      const navigatorHeader = navigator.querySelector('.navigator-header');
      navigatorHeader.textContent = 'Result Map';
      
      const navigatorGrid = document.getElementById('navigatorGrid');
      const buttons = navigatorGrid.querySelectorAll('.question-btn');
      
      // Clear all existing onclick handlers first
      buttons.forEach((btn) => {
        btn.removeEventListener('click', btn.reviewClickHandler);
        btn.onclick = null;
      });
      
      buttons.forEach((btn, index) => {
        btn.className = 'question-btn';
        
        if (userAnswers[index] === null) {
          btn.classList.add('unattempted');
        } else if (userAnswers[index] === questions[index].answer) {
          btn.classList.add('correct');
        } else {
          btn.classList.add('incorrect');
        }
        
        // Use a closure to properly capture the index
        const clickHandler = (function(questionIndex) {
          return function(e) {
            e.preventDefault();
            e.stopPropagation();
            reviewQuestion(questionIndex);
          };
        })(index);
        
        btn.reviewClickHandler = clickHandler;
        btn.addEventListener('click', clickHandler, false);
        btn.style.cursor = 'pointer';
      });

      submitBtn.style.display = 'none';
      
      let legendElement = navigator.querySelector('.result-legend');
      if (legendElement) {
        legendElement.remove();
      }
      
      const legend = document.createElement('div');
      legend.className = 'result-legend';
      legend.innerHTML = `
        <strong style="display: block; margin-bottom: 0.5rem; color: #222;">Legend:</strong>
        <div class="legend-item">
          <div class="legend-box" style="background: #4caf50; border-color: #4caf50;"></div>
          <span>Correct</span>
        </div>
        <div class="legend-item">
          <div class="legend-box" style="background: #f44336; border-color: #f44336;"></div>
          <span>Incorrect</span>
        </div>
        <div class="legend-item">
          <div class="legend-box" style="background: #ffffff; border-color: #ccc;"></div>
          <span>Unattempted</span>
        </div>
      `;
      navigator.appendChild(legend);
    }

    function reviewQuestion(index) {
      isReviewMode = true;
      currentQuestionIndex = index;
      const question = questions[index];
      const userAnswer = userAnswers[index];
      const correctAnswer = question.answer;
      
      // Check if answer is correct (handle both single and multiple correct answers)
      let isCorrect = false;
      if (Array.isArray(correctAnswer)) {
        isCorrect = correctAnswer.includes(userAnswer);
      } else {
        isCorrect = userAnswer === correctAnswer;
      }

      let html = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid #2e7d32;">
          <div style="font-weight: 600; color: #222;">Review Mode - Question ${index + 1}</div>
          <button onclick="exitReview()" style="background: #2e7d32; color: #fff; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">‚Üê Summary</button>
        </div>

        <div class="question-text">Q${index + 1}: ${question.q}</div>
      `;

      if (question.image && question.image.trim()) {
        html += `<img src="${question.image}" alt="Question Image" class="question-image">`;
      }

      html += `<div class="options">`;
      question.options.forEach((opt, j) => {
        let optionStyles = '';
        let labelStyles = '';
        let icon = '';
        let label = '';

        // Determine if this is a correct answer
        const isCorrectOption = Array.isArray(correctAnswer) ? correctAnswer.includes(j) : j === correctAnswer;

        if (isCorrectOption && j === userAnswer) {
          // User was correct
          optionStyles = 'background: #e8f5e9 !important; border-color: #4caf50 !important;';
          icon = '<i class="fas fa-check-circle" style="color: #4caf50; margin-right: 0.5rem; font-weight: 700;"></i>';
          label = '<span style="color: #4caf50; font-weight: 700; margin-left: 0.5rem;">(Your Choice ‚úì)</span>';
        } else if (isCorrectOption) {
          // Show correct answer when user was wrong
          optionStyles = 'background: #e8f5e9 !important; border-color: #4caf50 !important;';
          icon = '<i class="fas fa-check-circle" style="color: #4caf50; margin-right: 0.5rem; font-weight: 700;"></i>';
          label = '<span style="color: #4caf50; font-weight: 700; margin-left: 0.5rem;">(Correct Answer)</span>';
        } else if (j === userAnswer && !isCorrect) {
          // Highlight user's wrong choice
          optionStyles = 'background: #ffebee !important; border-color: #f44336 !important;';
          icon = '<i class="fas fa-times-circle" style="color: #f44336; margin-right: 0.5rem; font-weight: 700;"></i>';
          label = '<span style="color: #f44336; font-weight: 700; margin-left: 0.5rem;">(Your Choice ‚úó)</span>';
        }

        html += `
          <label style="${optionStyles}" style="pointer-events: none; opacity: 1;">
            <input type="radio" disabled ${j === userAnswer ? 'checked' : ''} style="margin-right: 0.75rem; cursor: not-allowed;">
            ${icon}
            ${opt}
            ${label}
          </label>
        `;
      });
      html += `</div>`;

      // Explanation Box
      const resultText = isCorrect ? 'You got this question right!' : 'You answered this question incorrectly.';
      const resultColor = isCorrect ? '#4caf50' : '#f44336';
      const resultBgColor = isCorrect ? '#e8f5e9' : '#ffebee';
      const borderColor = isCorrect ? '#4caf50' : '#f44336';

      // Get correct answer text
      let correctAnswerText = '';
      if (Array.isArray(correctAnswer)) {
        correctAnswerText = correctAnswer.map(idx => question.options[idx]).join(' or ');
      } else {
        correctAnswerText = question.options[correctAnswer];
      }

      html += `
        <div style="background: ${resultBgColor}; border-left: 4px solid ${borderColor}; padding: 1rem; border-radius: 6px; margin-top: 1.5rem; margin-bottom: 1rem;">
          <div style="font-weight: 700; color: ${resultColor}; margin-bottom: 0.5rem; font-size: 1rem;">
            ${resultText}
          </div>
          <div style="color: #333; font-size: 0.9rem; line-height: 1.6;">
            <strong>Correct Answer:</strong> ${correctAnswerText}
          </div>
          ${!isCorrect ? `<div style="color: #333; font-size: 0.9rem; line-height: 1.6; margin-top: 0.5rem;"><strong>Your Answer:</strong> ${question.options[userAnswer]}</div>` : ''}
        </div>
      `;

      html += `
        <div style="display: flex; gap: 0.8rem; justify-content: center; margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #e0e0e0;">
          <button onclick="reviewPrevious()" ${index === 0 ? 'disabled' : ''} style="background: #2e7d32; color: #fff; border: none; padding: 0.7rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; ${index === 0 ? 'opacity: 0.5; cursor: not-allowed;' : ''}">‚Üê Previous</button>
          <button onclick="reviewNext()" ${index === questions.length - 1 ? 'disabled' : ''} style="background: #2e7d32; color: #fff; border: none; padding: 0.7rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; ${index === questions.length - 1 ? 'opacity: 0.5; cursor: not-allowed;' : ''}">Next ‚Üí</button>
        </div>
      `;

      questionContent.innerHTML = html;
      updateReviewNavigator();
    }

    function reviewPrevious() {
      if (currentQuestionIndex > 0) {
        reviewQuestion(currentQuestionIndex - 1);
      }
    }

    function reviewNext() {
      if (currentQuestionIndex < questions.length - 1) {
        reviewQuestion(currentQuestionIndex + 1);
      }
    }

    function updateReviewNavigator() {
      questions.forEach((question, index) => {
        const btn = document.getElementById(`q-btn-${index}`);
        btn.classList.remove('current');
        btn.style.boxShadow = 'none';
        
        if (index === currentQuestionIndex) {
          btn.classList.add('current');
        }
      });
    }

    function exitReview() {
      isReviewMode = false;
      const score = userAnswers.filter((ans, idx) => ans === questions[idx].answer).length;
      const percentage = Math.round((score / questions.length) * 100);
      const isPassed = percentage >= 70;
      showPerformanceSummary(score, percentage, isPassed);
    }

    function showComprehensiveReview() {
      let html = `
        <div style="overflow-y: auto; height: 100%; display: flex; flex-direction: column;">
          <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid #2e7d32; flex-shrink: 0;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="font-weight: 600; color: #2e7d32; font-size: 1.1rem;">Complete Quiz Review</div>
              <button onclick="exitComprehensiveReview()" style="background: #2e7d32; color: #fff; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">‚Üê Back to Summary</button>
            </div>
          </div>
          <div style="flex: 1; overflow-y: auto; padding-right: 0.5rem;">
      `;

      questions.forEach((question, index) => {
        const userAnswer = userAnswers[index];
        const correctAnswer = question.answer;
        
        // Handle both single and multiple correct answers
        let isCorrect = false;
        if (Array.isArray(correctAnswer)) {
          isCorrect = correctAnswer.includes(userAnswer);
        } else {
          isCorrect = userAnswer === correctAnswer;
        }
        const isUnattempted = userAnswer === null;

        let statusBadge = '';
        let statusColor = '';
        if (isUnattempted) {
          statusBadge = 'Not Attempted';
          statusColor = '#999';
        } else if (isCorrect) {
          statusBadge = '‚úì Correct';
          statusColor = '#4caf50';
        } else {
          statusBadge = '‚úó Incorrect';
          statusColor = '#f44336';
        }

        html += `
          <div style="background: #f9f9f9; border-left: 4px solid ${statusColor}; padding: 1.2rem; margin-bottom: 1rem; border-radius: 6px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
              <div style="font-weight: 700; color: #2e7d32; font-size: 1rem;">Q${index + 1}: ${question.q}</div>
              <div style="background: ${statusColor}; color: #fff; padding: 0.4rem 0.8rem; border-radius: 4px; font-weight: 600; font-size: 0.85rem;">${statusBadge}</div>
            </div>
        `;

        if (question.image && question.image.trim()) {
          html += `<img src="${question.image}" alt="Question Image" style="width: 100%; max-height: 120px; object-fit: contain; border-radius: 4px; margin-bottom: 1rem;">`;
        }

        html += `<div style="background: #fff; border: 1px solid #e0e0e0; border-radius: 4px; padding: 1rem;">`;

        // Show all options with highlighting
        question.options.forEach((option, optIndex) => {
          let optStyle = '';
          let icon = '';

          if (optIndex === correctAnswer && optIndex === userAnswer) {
            optStyle = 'background: #e8f5e9; border-left: 3px solid #4caf50;';
            icon = '<i class="fas fa-check-circle" style="color: #4caf50; margin-right: 0.5rem;"></i>';
          } else if (optIndex === correctAnswer) {
            optStyle = 'background: #e8f5e9; border-left: 3px solid #4caf50;';
            icon = '<i class="fas fa-check-circle" style="color: #4caf50; margin-right: 0.5rem;"></i>';
          } else if (optIndex === userAnswer && !isCorrect) {
            optStyle = 'background: #ffebee; border-left: 3px solid #f44336;';
            icon = '<i class="fas fa-times-circle" style="color: #f44336; margin-right: 0.5rem;"></i>';
          }

          let label = '';
          if (optIndex === correctAnswer && optIndex === userAnswer) {
            label = '<span style="color: #4caf50; font-weight: 600; margin-left: auto;">(Your Answer - Correct)</span>';
          } else if (optIndex === correctAnswer) {
            label = '<span style="color: #4caf50; font-weight: 600; margin-left: auto;">(Correct Answer)</span>';
          } else if (optIndex === userAnswer && !isCorrect) {
            label = '<span style="color: #f44336; font-weight: 600; margin-left: auto;">(Your Answer)</span>';
          }

          html += `
            <div style="padding: 0.8rem; margin-bottom: 0.5rem; border-radius: 4px; display: flex; align-items: center; ${optStyle}">
              ${icon}
              <span>${option}</span>
              ${label}
            </div>
          `;
        });

        html += `</div>`;

        // Summary box
        if (isUnattempted) {
          html += `
            <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 0.8rem; margin-top: 1rem; border-radius: 4px;">
              <strong style="color: #ff9800;">Not Attempted</strong> - You did not select an answer for this question.
            </div>
          `;
        } else if (isCorrect) {
          html += `
            <div style="background: #e8f5e9; border-left: 4px solid #4caf50; padding: 0.8rem; margin-top: 1rem; border-radius: 4px;">
              <strong style="color: #4caf50;">Correct!</strong> Your answer matched the correct answer: <strong>${question.options[correctAnswer]}</strong>
            </div>
          `;
        } else {
          html += `
            <div style="background: #ffebee; border-left: 4px solid #f44336; padding: 0.8rem; margin-top: 1rem; border-radius: 4px;">
              <strong style="color: #f44336;">Incorrect</strong><br>
              Your answer: <strong>${question.options[userAnswer]}</strong><br>
              Correct answer: <strong>${question.options[correctAnswer]}</strong>
            </div>
          `;
        }

        html += `</div>`;
      });

      html += `</div></div>`;

      mainStage.innerHTML = html;
    }

    function exitComprehensiveReview() {
      const score = userAnswers.filter((ans, idx) => ans === questions[idx].answer).length;
      const percentage = Math.round((score / questions.length) * 100);
      const isPassed = percentage >= 70;
      showPerformanceSummary(score, percentage, isPassed);
    }

    function exitQuiz() {
      if (confirm('Are you sure you want to exit? Your answers will not be saved.')) {
        clearInterval(timerInterval);
        window.location.href = "index.html";
      }
    }

    function goBack() {
      clearInterval(timerInterval);
      window.location.href = "index.html";
    }
  </script>

  <!-- Firebase Module Script -->
  <script type="module">
    import { db, collection, addDoc } from './firebase.js';
    
    window.saveQuizAttemptToFirebase = async function(attemptData) {
      try {
        console.log("üìù Saving quiz attempt to Firebase...");
        console.log("Employee:", attemptData.employeeName);
        console.log("Score:", attemptData.score + "/" + attemptData.totalQuestions);
        
        const docRef = await addDoc(collection(db, "quizAttempts"), attemptData);
        console.log("‚úÖ Quiz attempt saved to Firebase with ID:", docRef.id);
        alert("‚úÖ Your quiz has been submitted and saved to the database!");
        return true;
      } catch (error) {
        console.error("‚ùå Error saving to Firebase:", error);
        console.error("Error message:", error.message);
        console.error("Error code:", error.code);
        alert("‚ö†Ô∏è Error saving to database, but your response was recorded locally.");
        return false;
      }
    };

    console.log("üî• Firebase module loaded on quiz.html");
    console.log("üí° Quiz submissions will be saved to Firebase automatically");
  </script>
</body>
</html>
